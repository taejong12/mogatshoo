<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
</head>

<body>
	<!-- ë‹¤ë¥¸ í˜ì´ì§€ì— í¬í•¨ë  ì‚¬ì´ë“œë°” ì¡°ê° -->
	<div th:fragment="sidebar" class="sidebar-component">
		<div class="sidebar">
			<!-- ë¡œê³  ì˜ì—­ -->
			<div class="sidebar-logo">
				<a th:href="@{/voting}">
					<div class="menu-icon">
						<img src="/img/icons/computer.png" alt="mogatshoo" class="logo-img">
					</div>
					<div class="logo-text">íƒˆëª¨ì™•ì¤‘ì™•</div>
				</a>
			</div>

			<!-- ë©”ë‰´ ì•„ì´í…œ -->
			<div class="sidebar-menu">
				<div class="menu-item">
					<a class="nav-link" th:href="@{/}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="í™ˆ">
						</div>
						<span class="menu-text">í™ˆ</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/fortune/start}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="ìš´ì„¸">
						</div>
						<span class="menu-text">ì˜¤ëŠ˜ìš´ì„¸</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hairLossTest/testHair}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="íƒˆëª¨ì§„ë‹¨">
						</div>
						<span class="menu-text">íƒˆëª¨ì§„ë‹¨</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hospitalMap/hospitals}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="ë³‘ì›ì§€ë„">
						</div>
						<span class="menu-text">ë³‘ì›ì§€ë„</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/point/shop/list}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="í¬ì¸íŠ¸ìƒµ">
						</div>
						<span class="menu-text">í¬ì¸íŠ¸ìƒµ</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/qanda/user}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="Q&A">
						</div>
						<span class="menu-text">Q & A</span>
					</a>
				</div>
			</div>

			<!-- í† ê¸€ ë²„íŠ¼ (ëª¨ë°”ì¼ ë·°ì—ì„œë§Œ ë³´ì„) -->
			<div class="sidebar-toggle">
				<button id="sidebarToggleBtn">
					<span class="toggle-icon">â˜°</span>
				</button>
			</div>
		</div>

		<!-- ìœˆë„ìš°95 ì°½ í…œí”Œë¦¿ -->
		<div id="win95Window" class="win95-window">
			<div class="win95-title-bar">
				<div class="win95-title-text">ë¬¸ì„œ</div>
				<div class="win95-close">Ã—</div>
			</div>
			<div class="win95-content">
				<iframe id="windowContentFrame"
					style="width:1300px; height:580px; border:none; overflow:hidden !important; background-color:#c0c0c0;"
					src="about:blank"></iframe>
			</div>
		</div>

		<!-- jQuery ì‚¬ìš© (ê°„í¸í•œ Ajax ì²˜ë¦¬ë¥¼ ìœ„í•´) -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<script>
			console.log("ğŸš€ iframe ìµœëŒ€ í¬ê¸° ì œí•œ ì‚¬ì´ë“œë°” ìŠ¤í¬ë¦½íŠ¸!");

			$(document).ready(function () {
			    // í˜„ì¬ ëª¨ë“œ ìƒíƒœ ê´€ë¦¬
			    let isIframeMode = true;
			    let currentPath = '';

			    // ğŸ”¥ iframe ìµœëŒ€ í¬ê¸° ì„¤ì • (ë” ì´ìƒ ì»¤ì§€ì§€ ì•ŠìŒ)
			    const MAX_IFRAME_SIZE = {
			        width: 1300,    // ìµœëŒ€ ë„ˆë¹„
			        height: 580     // ìµœëŒ€ ë†’ì´
			    };

			    // ëª¨ë°”ì¼ ê°ì§€ í•¨ìˆ˜
			    function isMobileDevice() {
			        return window.innerWidth <= 768;
			    }

			    // URL ë™ê¸°í™” í•¨ìˆ˜
			    function updateBrowserURL(path) {
			        if (path && path !== '/') {
			            window.history.pushState({path: path, mode: 'iframe'}, '', path);
			            currentPath = path;
			        }
			    }

			    // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
			    window.addEventListener('popstate', function (event) {
			        if (event.state) {
			            if (event.state.mode === 'iframe' && event.state.path) {
			                if (isMobileDevice()) {
			                    window.location.href = event.state.path;
			                } else {
			                    openInIframe(event.state.path, 'ë¬¸ì„œ');
			                }
			            } else {
			                window.location.href = event.state.path || '/';
			            }
			        }
			    });

			    // ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê²½ë¡œë“¤
			    const loginRequiredPaths = [
			        '/login',
			        '/member/login',
			        '/member/join',
			        '/oauth2/authorization/',
			        '/oauth2/join',
			        '/logout'
			    ];

			    function requiresMainWindow(path) {
			        return loginRequiredPaths.some(loginPath => path.includes(loginPath));
			    }

			    // iframeì—ì„œ ì½˜í…ì¸  ë¡œë“œ í•¨ìˆ˜
			    function openInIframe(file, title) {
			        if (isMobileDevice()) {
			            console.log('ğŸ“± ëª¨ë°”ì¼ì—ì„œ ì§ì ‘ í˜ì´ì§€ ì´ë™:', file);
			            window.location.href = file;
			            return;
			        }

			        console.log('ğŸ’» iframeì—ì„œ ë¡œë“œ:', file);

			        $('.win95-title-text').text(title);

			        // ğŸ”¥ iframe í¬ê¸° ê²°ì • ë¡œì§ (ìµœëŒ€ í¬ê¸° ì œí•œ)
			        const windowWidth = window.innerWidth;
			        const windowHeight = window.innerHeight;
			        
			        // í™”ë©´ í¬ê¸°ì— ë”°ë¼ iframe í¬ê¸° ê³„ì‚° (ìµœëŒ€ í¬ê¸°ë¥¼ ë„˜ì§€ ì•ŠìŒ)
			        const availableWidth = windowWidth - 100;  // ì¢Œìš° ì—¬ë°± 50pxì”©
			        const availableHeight = windowHeight - 100; // ìƒí•˜ ì—¬ë°± 50pxì”©
			        
			        // ìµœëŒ€ í¬ê¸°ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ì œí•œ
			        const iframeWidth = Math.min(MAX_IFRAME_SIZE.width, availableWidth);
			        const iframeHeight = Math.min(MAX_IFRAME_SIZE.height, availableHeight);
			        
			        // ìœˆë„ìš° í¬ê¸° (iframe + í…Œë‘ë¦¬)
			        const windowWidth95 = iframeWidth + 20;
			        const windowHeight95 = iframeHeight + 40;

			        $('#win95Window').css({
			            'display': 'block',
			            'position': 'fixed',
			            'width': windowWidth95 + 'px',
			            'height': windowHeight95 + 'px',
			            'left': '50%',
			            'top': '50%',
			            'transform': 'translate(-50%, -50%)',
			            'z-index': '1000'
			        });

			        const iframe = $('#windowContentFrame');
			        iframe.css({
			            'width': iframeWidth + 'px',
			            'height': iframeHeight + 'px',
			            'overflow': 'hidden',
			            'overflow-x': 'hidden',
			            'overflow-y': 'hidden'
			        });

			        iframe.attr('src', file);
			        updateBrowserURL(file);
			        
			        console.log(`ğŸ“ iframe í¬ê¸°: ${iframeWidth}x${iframeHeight} (ìµœëŒ€: ${MAX_IFRAME_SIZE.width}x${MAX_IFRAME_SIZE.height})`);
			    }

			    // ë©”ì¸ ìœˆë„ìš°ì—ì„œ í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜
			    function openInMainWindow(file) {
			        console.log('ğŸŒ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ë¡œë“œ:', file);
			        isIframeMode = false;
			        window.location.href = file;
			    }

			    // ì‚¬ì´ë“œë°” í•­ëª© í´ë¦­ ì‹œ
			    $('.menu-item a, .auth-item a, .auth-profile a').click(function (e) {
			        if ($(this).hasClass('footer-link')) {
			            return;
			        }

			        e.preventDefault();

			        const file = $(this).attr('href');
			        const title = $(this).find('.menu-text').text() || 'ë¬¸ì„œ';

			        console.log('ğŸ–±ï¸ ì‚¬ì´ë“œë°” ë§í¬ í´ë¦­:', file, title);

			        if (file === '/') {
			            window.location.href = file;
			            return;
			        }

			        if (requiresMainWindow(file)) {
			            console.log('ğŸ”´ ë¡œê·¸ì¸/íšŒì›ê°€ì…ì€ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬:', file);
			            $('#win95Window').hide();
			            $('#windowContentFrame').attr('src', 'about:blank');
			            window.location.href = file;
			            return;
			        }

			        if (isMobileDevice()) {
			            console.log('ğŸ“± ëª¨ë°”ì¼ì—ì„œ ì§ì ‘ ì´ë™:', file);
			            window.location.href = file;
			            return;
			        }

			        console.log('ğŸ’» ë°ìŠ¤í¬í†±ì—ì„œ iframe ì²˜ë¦¬:', file);
			        openInIframe(file, title);
			    });

			    // iframe ë¡œë“œ ì™„ë£Œ í›„ ì²˜ë¦¬
			    let isProcessing = false;
			    $('#windowContentFrame').off('load').on('load', function () {
			        if (isMobileDevice()) {
			            return;
			        }

			        if (isProcessing) {
			            return;
			        }

			        $(this).css({
			            'overflow': 'hidden !important',
			            'overflow-x': 'hidden !important',
			            'overflow-y': 'hidden !important'
			        });

			        try {
			            const iframeURL = this.contentWindow.location.href;
			            const currentHost = window.location.host;

			            console.log("=== iframe load ì´ë²¤íŠ¸ ===");
			            console.log("iframe URL:", iframeURL);

			            if (iframeURL === 'about:blank' || iframeURL === '') {
			                return;
			            }

			            if (iframeURL.indexOf('/member/login') !== -1) {
			                console.log("ğŸ”´ ë¡œê·¸ì¸ í˜ì´ì§€ ê°ì§€ë¨!");
			                isProcessing = true;

			                $('#win95Window').hide();
			                $('#windowContentFrame').attr('src', 'about:blank');

			                try {
			                    window.top.location.href = '/member/login';
			                } catch (e) {
			                    window.location.href = '/member/login';
			                }
			                return;
			            }

			            if (iframeURL.includes(`//${currentHost}/`) && !iframeURL.endsWith('about:blank')) {
			                const path = new URL(iframeURL).pathname + new URL(iframeURL).search;
			                if (path !== currentPath && path !== '/') {
			                    updateBrowserURL(path);
			                }
			            }

			            if (iframeURL.includes(`//${currentHost}/`) && 
			                (iframeURL.endsWith('/') || iframeURL.includes('?success'))) {
			                console.log("ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ ê°ì§€ë¨");
			                $('#win95Window').hide();
			                isIframeMode = true;
			                window.location.href = '/';
			                return;
			            }

			            const iframe = document.getElementById('windowContentFrame');
			            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

			            if (iframeDoc && iframeDoc.body) {
			                iframeDoc.body.style.overflow = 'hidden';
			            }

			            const sidebars = iframeDoc.querySelectorAll('.sidebar, .sidebar-component, .side-nav, #sidebar');
			            sidebars.forEach(sidebar => {
			                if (sidebar) sidebar.style.display = 'none';
			            });

			            const footers = iframeDoc.querySelectorAll('footer, .footer, .site-footer, #footer');
			            footers.forEach(footer => {
			                if (footer) footer.style.display = 'none';
			            });

			            const mainContents = iframeDoc.querySelectorAll('.content-with-sidebar, main, #main, .main-content');
			            mainContents.forEach(content => {
			                if (content) {
			                    content.style.marginLeft = '0';
			                    content.style.width = '100%';
			                    content.style.overflow = 'hidden';
			                }
			            });

			            const links = iframeDoc.querySelectorAll('a');
			            links.forEach(link => {
			                if (!link.hasAttribute('data-processed')) {
			                    link.addEventListener('click', function (e) {
			                        const href = this.getAttribute('href');
			                        if (href && requiresMainWindow(href)) {
			                            e.preventDefault();
			                            console.log('ğŸ”´ iframe ë‚´ë¶€ ë§í¬ë¥¼ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬:', href);
			                            window.parent.location.href = href;
			                        }
			                    });
			                    link.setAttribute('data-processed', 'true');
			                }
			            });

			            setTimeout(() => {
			                isProcessing = false;
			            }, 1000);

			        } catch (e) {
			            console.error("iframe ë‚´ë¶€ ìš”ì†Œ ì ‘ê·¼ ì˜¤ë¥˜:", e);
			            isProcessing = false;
			        }
			    });

			    // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
			    $('.win95-close').click(function () {
			        $('#win95Window').hide();
			        $('#windowContentFrame').attr('src', 'about:blank');
			        window.history.pushState({path: '/', mode: 'normal'}, '', '/');
			        currentPath = '';
			    });

			    // ë“œë˜ê·¸ ê¸°ëŠ¥
			    let isDragging = false;
			    let offsetX, offsetY;

			    $('.win95-title-bar').mousedown(function (e) {
			        if (isMobileDevice()) return;
			        
			        isDragging = true;
			        offsetX = e.clientX - $('#win95Window').position().left;
			        offsetY = e.clientY - $('#win95Window').position().top;

			        $(document).mousemove(function (e) {
			            if (isDragging) {
			                $('#win95Window').css({
			                    left: e.clientX - offsetX,
			                    top: e.clientY - offsetY,
			                    transform: 'none'
			                });
			            }
			        });

			        $(document).mouseup(function () {
			            isDragging = false;
			            $(document).off('mousemove');
			            $(document).off('mouseup');
			        });
			    });

			    // í˜ì´ì§€ ë¡œë“œ ì‹œ URL ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
			    const currentURL = window.location.pathname + window.location.search;
			    if (currentURL !== '/' && !requiresMainWindow(currentURL)) {
			        if (!isMobileDevice()) {
			            const title = 'ë¬¸ì„œ';
			            openInIframe(currentURL, title);
			        }
			    }

			    // ğŸ”¥ ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ iframe í¬ê¸° ì¬ì¡°ì • (ìµœëŒ€ í¬ê¸° ì œí•œ)
			    function adjustWindowSizeOnResize() {
			        if (isMobileDevice()) {
			            const win95Window = $('#win95Window');
			            if (win95Window.is(':visible')) {
			                console.log('ğŸ“± ëª¨ë°”ì¼ ê°ì§€: iframe ìœˆë„ìš° ìˆ¨ê¹€');
			                win95Window.hide();
			                $('#windowContentFrame').attr('src', 'about:blank');
			            }
			            return;
			        }

			        const win95Window = $('#win95Window');
			        if (!win95Window.is(':visible')) return;

			        const windowWidth = window.innerWidth;
			        const windowHeight = window.innerHeight;
			        
			        const availableWidth = windowWidth - 100;
			        const availableHeight = windowHeight - 100;
			        
			        // ğŸ”¥ ìµœëŒ€ í¬ê¸°ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ì œí•œ
			        const iframeWidth = Math.min(MAX_IFRAME_SIZE.width, availableWidth);
			        const iframeHeight = Math.min(MAX_IFRAME_SIZE.height, availableHeight);
			        
			        const windowWidth95 = iframeWidth + 20;
			        const windowHeight95 = iframeHeight + 40;

			        win95Window.css({
			            'width': windowWidth95 + 'px',
			            'height': windowHeight95 + 'px',
			            'left': '50%',
			            'top': '50%',
			            'transform': 'translate(-50%, -50%)'
			        });

			        $('#windowContentFrame').css({
			            'width': iframeWidth + 'px',
			            'height': iframeHeight + 'px',
			            'overflow': 'hidden'
			        });

			        console.log(`ğŸ”„ ë¦¬ì‚¬ì´ì¦ˆ: iframe í¬ê¸° ${iframeWidth}x${iframeHeight} (ìµœëŒ€: ${MAX_IFRAME_SIZE.width}x${MAX_IFRAME_SIZE.height})`);
			    }

			    // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
			    $(window).resize(adjustWindowSizeOnResize);
			});
		</script>
	</div>
</body>

</html>