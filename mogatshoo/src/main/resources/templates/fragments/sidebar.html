<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
</head>

<body>
	<!-- 다른 페이지에 포함될 사이드바 조각 -->
	<div th:fragment="sidebar" class="sidebar-component">
		<div class="sidebar">
			<!-- 로고 영역 -->
			<div class="sidebar-logo">
				<a th:href="@{/voting}">
					<div class="menu-icon">
						<img src="/img/icons/computer.png" alt="mogatshoo" class="logo-img">
					</div>
					<div class="logo-text">탈모왕중왕</div>
				</a>
			</div>

			<!-- 메뉴 아이템 -->
			<div class="sidebar-menu">
				<div class="menu-item">
					<a class="nav-link" th:href="@{/}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="홈">
						</div>
						<span class="menu-text">홈</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/fortune/start}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="운세">
						</div>
						<span class="menu-text">오늘운세</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hairLossTest/testHair}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="탈모진단">
						</div>
						<span class="menu-text">탈모진단</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hospitalMap/hospitals}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="병원지도">
						</div>
						<span class="menu-text">병원지도</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/point/shop/list}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="포인트샵">
						</div>
						<span class="menu-text">포인트샵</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/qanda/user}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="Q&A">
						</div>
						<span class="menu-text">Q & A</span>
					</a>
				</div>
			</div>

			<!-- 토글 버튼 (모바일 뷰에서만 보임) -->
			<div class="sidebar-toggle">
				<button id="sidebarToggleBtn">
					<span class="toggle-icon">☰</span>
				</button>
			</div>
		</div>

		<!-- 윈도우95 창 템플릿 -->
		<div id="win95Window" class="win95-window">
			<div class="win95-title-bar">
				<div class="win95-title-text">문서</div>
				<div class="win95-close">×</div>
			</div>
			<div class="win95-content">
				<iframe id="windowContentFrame"
					style="width:1300px; height:580px; border:none; overflow:hidden !important; background-color:#c0c0c0;"
					src="about:blank"></iframe>
			</div>
		</div>

		<!-- jQuery 사용 (간편한 Ajax 처리를 위해) -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<script>
			console.log("🚀 iframe 최대 크기 제한 사이드바 스크립트!");

			$(document).ready(function () {
			    // 현재 모드 상태 관리
			    let isIframeMode = true;
			    let currentPath = '';

			    // 🔥 iframe 최대 크기 설정 (더 이상 커지지 않음)
			    const MAX_IFRAME_SIZE = {
			        width: 1300,    // 최대 너비
			        height: 580     // 최대 높이
			    };

			    // 모바일 감지 함수
			    function isMobileDevice() {
			        return window.innerWidth <= 768;
			    }

			    // URL 동기화 함수
			    function updateBrowserURL(path) {
			        if (path && path !== '/') {
			            window.history.pushState({path: path, mode: 'iframe'}, '', path);
			            currentPath = path;
			        }
			    }

			    // 브라우저 뒤로가기/앞으로가기 처리
			    window.addEventListener('popstate', function (event) {
			        if (event.state) {
			            if (event.state.mode === 'iframe' && event.state.path) {
			                if (isMobileDevice()) {
			                    window.location.href = event.state.path;
			                } else {
			                    openInIframe(event.state.path, '문서');
			                }
			            } else {
			                window.location.href = event.state.path || '/';
			            }
			        }
			    });

			    // 로그인이 필요한 경로들
			    const loginRequiredPaths = [
			        '/login',
			        '/member/login',
			        '/member/join',
			        '/oauth2/authorization/',
			        '/oauth2/join',
			        '/logout'
			    ];

			    function requiresMainWindow(path) {
			        return loginRequiredPaths.some(loginPath => path.includes(loginPath));
			    }

			    // iframe에서 콘텐츠 로드 함수
			    function openInIframe(file, title) {
			        if (isMobileDevice()) {
			            console.log('📱 모바일에서 직접 페이지 이동:', file);
			            window.location.href = file;
			            return;
			        }

			        console.log('💻 iframe에서 로드:', file);

			        $('.win95-title-text').text(title);

			        // 🔥 iframe 크기 결정 로직 (최대 크기 제한)
			        const windowWidth = window.innerWidth;
			        const windowHeight = window.innerHeight;
			        
			        // 화면 크기에 따라 iframe 크기 계산 (최대 크기를 넘지 않음)
			        const availableWidth = windowWidth - 100;  // 좌우 여백 50px씩
			        const availableHeight = windowHeight - 100; // 상하 여백 50px씩
			        
			        // 최대 크기를 넘지 않도록 제한
			        const iframeWidth = Math.min(MAX_IFRAME_SIZE.width, availableWidth);
			        const iframeHeight = Math.min(MAX_IFRAME_SIZE.height, availableHeight);
			        
			        // 윈도우 크기 (iframe + 테두리)
			        const windowWidth95 = iframeWidth + 20;
			        const windowHeight95 = iframeHeight + 40;

			        $('#win95Window').css({
			            'display': 'block',
			            'position': 'fixed',
			            'width': windowWidth95 + 'px',
			            'height': windowHeight95 + 'px',
			            'left': '50%',
			            'top': '50%',
			            'transform': 'translate(-50%, -50%)',
			            'z-index': '1000'
			        });

			        const iframe = $('#windowContentFrame');
			        iframe.css({
			            'width': iframeWidth + 'px',
			            'height': iframeHeight + 'px',
			            'overflow': 'hidden',
			            'overflow-x': 'hidden',
			            'overflow-y': 'hidden'
			        });

			        iframe.attr('src', file);
			        updateBrowserURL(file);
			        
			        console.log(`📐 iframe 크기: ${iframeWidth}x${iframeHeight} (최대: ${MAX_IFRAME_SIZE.width}x${MAX_IFRAME_SIZE.height})`);
			    }

			    // 메인 윈도우에서 페이지 로드 함수
			    function openInMainWindow(file) {
			        console.log('🌐 메인 윈도우에서 로드:', file);
			        isIframeMode = false;
			        window.location.href = file;
			    }

			    // 사이드바 항목 클릭 시
			    $('.menu-item a, .auth-item a, .auth-profile a').click(function (e) {
			        if ($(this).hasClass('footer-link')) {
			            return;
			        }

			        e.preventDefault();

			        const file = $(this).attr('href');
			        const title = $(this).find('.menu-text').text() || '문서';

			        console.log('🖱️ 사이드바 링크 클릭:', file, title);

			        if (file === '/') {
			            window.location.href = file;
			            return;
			        }

			        if (requiresMainWindow(file)) {
			            console.log('🔴 로그인/회원가입은 메인 윈도우에서 처리:', file);
			            $('#win95Window').hide();
			            $('#windowContentFrame').attr('src', 'about:blank');
			            window.location.href = file;
			            return;
			        }

			        if (isMobileDevice()) {
			            console.log('📱 모바일에서 직접 이동:', file);
			            window.location.href = file;
			            return;
			        }

			        console.log('💻 데스크톱에서 iframe 처리:', file);
			        openInIframe(file, title);
			    });

			    // iframe 로드 완료 후 처리
			    let isProcessing = false;
			    $('#windowContentFrame').off('load').on('load', function () {
			        if (isMobileDevice()) {
			            return;
			        }

			        if (isProcessing) {
			            return;
			        }

			        $(this).css({
			            'overflow': 'hidden !important',
			            'overflow-x': 'hidden !important',
			            'overflow-y': 'hidden !important'
			        });

			        try {
			            const iframeURL = this.contentWindow.location.href;
			            const currentHost = window.location.host;

			            console.log("=== iframe load 이벤트 ===");
			            console.log("iframe URL:", iframeURL);

			            if (iframeURL === 'about:blank' || iframeURL === '') {
			                return;
			            }

			            if (iframeURL.indexOf('/member/login') !== -1) {
			                console.log("🔴 로그인 페이지 감지됨!");
			                isProcessing = true;

			                $('#win95Window').hide();
			                $('#windowContentFrame').attr('src', 'about:blank');

			                try {
			                    window.top.location.href = '/member/login';
			                } catch (e) {
			                    window.location.href = '/member/login';
			                }
			                return;
			            }

			            if (iframeURL.includes(`//${currentHost}/`) && !iframeURL.endsWith('about:blank')) {
			                const path = new URL(iframeURL).pathname + new URL(iframeURL).search;
			                if (path !== currentPath && path !== '/') {
			                    updateBrowserURL(path);
			                }
			            }

			            if (iframeURL.includes(`//${currentHost}/`) && 
			                (iframeURL.endsWith('/') || iframeURL.includes('?success'))) {
			                console.log("메인 페이지로 이동 감지됨");
			                $('#win95Window').hide();
			                isIframeMode = true;
			                window.location.href = '/';
			                return;
			            }

			            const iframe = document.getElementById('windowContentFrame');
			            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

			            if (iframeDoc && iframeDoc.body) {
			                iframeDoc.body.style.overflow = 'hidden';
			            }

			            const sidebars = iframeDoc.querySelectorAll('.sidebar, .sidebar-component, .side-nav, #sidebar');
			            sidebars.forEach(sidebar => {
			                if (sidebar) sidebar.style.display = 'none';
			            });

			            const footers = iframeDoc.querySelectorAll('footer, .footer, .site-footer, #footer');
			            footers.forEach(footer => {
			                if (footer) footer.style.display = 'none';
			            });

			            const mainContents = iframeDoc.querySelectorAll('.content-with-sidebar, main, #main, .main-content');
			            mainContents.forEach(content => {
			                if (content) {
			                    content.style.marginLeft = '0';
			                    content.style.width = '100%';
			                    content.style.overflow = 'hidden';
			                }
			            });

			            const links = iframeDoc.querySelectorAll('a');
			            links.forEach(link => {
			                if (!link.hasAttribute('data-processed')) {
			                    link.addEventListener('click', function (e) {
			                        const href = this.getAttribute('href');
			                        if (href && requiresMainWindow(href)) {
			                            e.preventDefault();
			                            console.log('🔴 iframe 내부 링크를 메인 윈도우에서 처리:', href);
			                            window.parent.location.href = href;
			                        }
			                    });
			                    link.setAttribute('data-processed', 'true');
			                }
			            });

			            setTimeout(() => {
			                isProcessing = false;
			            }, 1000);

			        } catch (e) {
			            console.error("iframe 내부 요소 접근 오류:", e);
			            isProcessing = false;
			        }
			    });

			    // 닫기 버튼 클릭 시
			    $('.win95-close').click(function () {
			        $('#win95Window').hide();
			        $('#windowContentFrame').attr('src', 'about:blank');
			        window.history.pushState({path: '/', mode: 'normal'}, '', '/');
			        currentPath = '';
			    });

			    // 드래그 기능
			    let isDragging = false;
			    let offsetX, offsetY;

			    $('.win95-title-bar').mousedown(function (e) {
			        if (isMobileDevice()) return;
			        
			        isDragging = true;
			        offsetX = e.clientX - $('#win95Window').position().left;
			        offsetY = e.clientY - $('#win95Window').position().top;

			        $(document).mousemove(function (e) {
			            if (isDragging) {
			                $('#win95Window').css({
			                    left: e.clientX - offsetX,
			                    top: e.clientY - offsetY,
			                    transform: 'none'
			                });
			            }
			        });

			        $(document).mouseup(function () {
			            isDragging = false;
			            $(document).off('mousemove');
			            $(document).off('mouseup');
			        });
			    });

			    // 페이지 로드 시 URL 기반으로 초기 상태 설정
			    const currentURL = window.location.pathname + window.location.search;
			    if (currentURL !== '/' && !requiresMainWindow(currentURL)) {
			        if (!isMobileDevice()) {
			            const title = '문서';
			            openInIframe(currentURL, title);
			        }
			    }

			    // 🔥 윈도우 리사이즈 시 iframe 크기 재조정 (최대 크기 제한)
			    function adjustWindowSizeOnResize() {
			        if (isMobileDevice()) {
			            const win95Window = $('#win95Window');
			            if (win95Window.is(':visible')) {
			                console.log('📱 모바일 감지: iframe 윈도우 숨김');
			                win95Window.hide();
			                $('#windowContentFrame').attr('src', 'about:blank');
			            }
			            return;
			        }

			        const win95Window = $('#win95Window');
			        if (!win95Window.is(':visible')) return;

			        const windowWidth = window.innerWidth;
			        const windowHeight = window.innerHeight;
			        
			        const availableWidth = windowWidth - 100;
			        const availableHeight = windowHeight - 100;
			        
			        // 🔥 최대 크기를 넘지 않도록 제한
			        const iframeWidth = Math.min(MAX_IFRAME_SIZE.width, availableWidth);
			        const iframeHeight = Math.min(MAX_IFRAME_SIZE.height, availableHeight);
			        
			        const windowWidth95 = iframeWidth + 20;
			        const windowHeight95 = iframeHeight + 40;

			        win95Window.css({
			            'width': windowWidth95 + 'px',
			            'height': windowHeight95 + 'px',
			            'left': '50%',
			            'top': '50%',
			            'transform': 'translate(-50%, -50%)'
			        });

			        $('#windowContentFrame').css({
			            'width': iframeWidth + 'px',
			            'height': iframeHeight + 'px',
			            'overflow': 'hidden'
			        });

			        console.log(`🔄 리사이즈: iframe 크기 ${iframeWidth}x${iframeHeight} (최대: ${MAX_IFRAME_SIZE.width}x${MAX_IFRAME_SIZE.height})`);
			    }

			    // 리사이즈 이벤트
			    $(window).resize(adjustWindowSizeOnResize);
			});
		</script>
	</div>
</body>

</html>