<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
</head>

<body>
	<div th:fragment="sidebar" class="sidebar-component">
		<div class="sidebar">
			<div class="sidebar-logo">
				<a th:href="@{/voting}">
					<div class="menu-icon">
						<img src="/img/icons/computer.png" alt="mogatshoo" class="logo-img">
					</div>
					<div class="logo-text">íƒˆëª¨ì™•ì¤‘ì™•</div>
				</a>
			</div>

			<div class="sidebar-menu">
				<div class="menu-item">
					<a class="nav-link" th:href="@{/}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="í™ˆ">
						</div>
						<span class="menu-text">í™ˆ</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/fortune/start}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="ìš´ì„¸">
						</div>
						<span class="menu-text">ì˜¤ëŠ˜ìš´ì„¸</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hairLossTest/testHair}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="íƒˆëª¨ì§„ë‹¨">
						</div>
						<span class="menu-text">íƒˆëª¨ì§„ë‹¨</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hospitalMap/hospitals}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="ë³‘ì›ì§€ë„">
						</div>
						<span class="menu-text">ë³‘ì›ì§€ë„</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/point/shop/list}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="í¬ì¸íŠ¸ìƒµ">
						</div>
						<span class="menu-text">í¬ì¸íŠ¸ìƒµ</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/qanda/user}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="Q&A">
						</div>
						<span class="menu-text">Q & A</span>
					</a>
				</div>
			</div>

			<div class="sidebar-toggle">
				<button id="sidebarToggleBtn">
					<span class="toggle-icon">â˜°</span>
				</button>
			</div>
		</div>

		<div id="win95Window" class="win95-window">
			<div class="win95-title-bar">
				<div class="win95-title-text">ë¬¸ì„œ</div>
				<div class="win95-close">Ã—</div>
			</div>
			<div class="win95-content">
				<iframe id="windowContentFrame"
					style="width:1300px; height:580px; border:none; overflow:hidden !important; background-color:#c0c0c0;"
					src="about:blank"></iframe>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<script>
			console.log("ğŸš€ ì‚¬ì´ë“œë°” ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - ìµœì¢… ë²„ì „!");

			$(document).ready(function () {
				// í˜„ì¬ ëª¨ë“œ ìƒíƒœ ê´€ë¦¬
				let isIframeMode = true;
				let currentPath = '';

				// URL ë™ê¸°í™” í•¨ìˆ˜
				function updateBrowserURL(path) {
					if (path && path !== '/') {
						// History APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì € URL ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
						window.history.pushState({ path: path, mode: 'iframe' }, '', path);
						currentPath = path;
					}
				}

				// ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
				window.addEventListener('popstate', function (event) {
					if (event.state) {
						if (event.state.mode === 'iframe' && event.state.path) {
							// iframe ëª¨ë“œë¡œ í•´ë‹¹ ê²½ë¡œ ë¡œë“œ
							openInIframe(event.state.path, 'ë¬¸ì„œ');
						} else {
							// ì¼ë°˜ í˜ì´ì§€ ì´ë™
							window.location.href = event.state.path || '/';
						}
					}
				});

				// ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê²½ë¡œë“¤ (ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬)
				const loginRequiredPaths = [
					'/login',
					'/member/login',
					'/member/join',          // íšŒì›ê°€ì…
					'/oauth2/authorization/',  // ì†Œì…œ ë¡œê·¸ì¸ë„ ë©”ì¸ ìœˆë„ìš°ì—ì„œ
					'/oauth2/join',
					'/logout'
				];

				// ë¡œê·¸ì¸ ê²½ë¡œ ì²´í¬ (ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬)
				function requiresMainWindow(path) {
					return loginRequiredPaths.some(loginPath => path.includes(loginPath));
				}

				// iframeì—ì„œ ì½˜í…ì¸  ë¡œë“œ í•¨ìˆ˜
				function openInIframe(file, title) {
					console.log('iframeì—ì„œ ë¡œë“œ:', file);

					// ìœˆë„ìš° ì œëª© ì„¤ì •
					$('.win95-title-text').text(title);

					// ìœˆë„ìš° í‘œì‹œ ë° ìœ„ì¹˜ ì„¤ì •
					$('#win95Window').css({
						'display': 'block',
						'position': 'fixed'
					});
					
					// ì°½ì„ ì—´ ë•Œ ì¦‰ì‹œ í¬ê¸° ì¡°ì •
					adjustWindowSize();

					// iframe ì†ŒìŠ¤ ì„¤ì • ë° overflow ê°•ì œ ì ìš©
					const iframe = $('#windowContentFrame');
					iframe.attr('src', file).css({
						'overflow': 'hidden',
						'overflow-x': 'hidden',
						'overflow-y': 'hidden'
					});

					// URL ë™ê¸°í™”
					updateBrowserURL(file);
				}

				// ë©”ì¸ ìœˆë„ìš°ì—ì„œ í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜ (ë¡œê·¸ì¸ìš©)
				function openInMainWindow(file) {
					console.log('ë©”ì¸ ìœˆë„ìš°ì—ì„œ ë¡œë“œ:', file);
					isIframeMode = false;

					// í˜„ì¬ ì°½ì—ì„œ ì§ì ‘ ì´ë™
					window.location.href = file;
				}

				// ì‚¬ì´ë“œë°” í•­ëª© í´ë¦­ ì‹œ
				$('.menu-item a, .auth-item a, .auth-profile a').click(function (e) {
					// ğŸš¨ í‘¸í„° ë§í¬ëŠ” ì œì™¸ (í‘¸í„°ì—ì„œ ë³„ë„ ì²˜ë¦¬)
					if ($(this).hasClass('footer-link')) {
						return; // í‘¸í„° ë§í¬ëŠ” ì‚¬ì´ë“œë°”ì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
					}

					e.preventDefault(); // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€

					// í´ë¦­ëœ ë§í¬ì˜ href ì†ì„±ì—ì„œ íŒŒì¼ ê²½ë¡œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
					const file = $(this).attr('href');
					// ë©”ë‰´ í…ìŠ¤íŠ¸ì—ì„œ ì°½ì˜ ì œëª©ì„ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ 'ë¬¸ì„œ'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
					const title = $(this).find('.menu-text').text() || 'ë¬¸ì„œ';

					console.log('ì‚¬ì´ë“œë°” ë§í¬ í´ë¦­:', file, title);

					// '/' ë§í¬ëŠ” ì¼ë°˜ì ì¸ í˜ì´ì§€ ì´ë™ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
					if (file === '/') {
						window.location.href = file;
						return;
					}

					// ğŸš¨ íšŒì›ê°€ì…/ë¡œê·¸ì¸/ì†Œì…œë¡œê·¸ì¸ ë§í¬ëŠ” iframeì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
					if (requiresMainWindow(file)) {
						console.log('ğŸ”´ ë¡œê·¸ì¸/íšŒì›ê°€ì…/ì†Œì…œë¡œê·¸ì¸ì€ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬:', file);

						// iframe ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸°
						$('#win95Window').hide();
						$('#windowContentFrame').attr('src', 'about:blank');

						// ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì§ì ‘ ì´ë™
						window.location.href = file;
						return;
					}

					// ì¼ë°˜ í˜ì´ì§€ë§Œ iframeì—ì„œ ì²˜ë¦¬
					console.log('ğŸ”µ iframeì—ì„œ ì²˜ë¦¬:', file);
					openInIframe(file, title);
				});

				// iframe ë¡œë“œ ì™„ë£Œ í›„ ì²˜ë¦¬ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
				let isProcessing = false;
				$('#windowContentFrame').off('load').on('load', function () {
					// ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
					if (isProcessing) {
						console.log("âš ï¸ ì´ë¯¸ ì²˜ë¦¬ ì¤‘, ë¬´ì‹œ");
						return;
					}

					// iframe overflow ì¬ì„¤ì • (ë¡œë“œ í›„ì—ë„ ìœ ì§€)
					$(this).css({
						'overflow': 'hidden !important',
						'overflow-x': 'hidden !important',
						'overflow-y': 'hidden !important'
					});

					try {
						// iframeì˜ í˜„ì¬ URL ê°€ì ¸ì˜¤ê¸°
						const iframeURL = this.contentWindow.location.href;
						const currentHost = window.location.host; // í˜„ì¬ ë„ë©”ì¸

						console.log("=== iframe load ì´ë²¤íŠ¸ ===");
						console.log("iframe í˜„ì¬ URL:", iframeURL);
						console.log("ì‹œê°„:", new Date().toLocaleTimeString());

						// about:blankëŠ” ë¬´ì‹œ
						if (iframeURL === 'about:blank' || iframeURL === '') {
							console.log("about:blank ë¬´ì‹œ");
							return;
						}

						// ğŸš¨ ë¡œê·¸ì¸ í˜ì´ì§€ì¸ì§€ ë¨¼ì € ì²´í¬
						if (iframeURL.indexOf('/member/login') !== -1) {
							console.log("ğŸ”´ ë¡œê·¸ì¸ í˜ì´ì§€ ê°ì§€ë¨! ì²˜ë¦¬ ì‹œì‘");
							isProcessing = true; // ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸

							// iframe ì¦‰ì‹œ ì •ë¦¬
							$('#win95Window').hide();
							$('#windowContentFrame').attr('src', 'about:blank');

							// ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì¦‰ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
							console.log("ğŸš€ ë©”ì¸ ìœˆë„ìš°ë¡œ ê°•ì œ ì´ë™");
							window.top.location.href = '/member/login';
							return; // ì´í›„ ëª¨ë“  ì²˜ë¦¬ ì¤‘ë‹¨
						}

						// URL ë™ê¸°í™” (iframe ë‚´ì—ì„œ ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ì´ ë°œìƒí•œ ê²½ìš°)
						if (iframeURL.includes(`//${currentHost}/`) && !iframeURL.endsWith('about:blank')) {
							const path = new URL(iframeURL).pathname + new URL(iframeURL).search;
							if (path !== currentPath && path !== '/') {
								updateBrowserURL(path);
							}
						}

						// ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²½ìš° (ë¡œê·¸ì¸ ì„±ê³µ í›„ ë“±)
						if (iframeURL.includes(`//${currentHost}/`) && (iframeURL.endsWith('/') || iframeURL.includes('?loginSuccess'))) {
							console.log("ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ ê°ì§€ë¨, ì°½ ë‹«ê³  ìµœìƒìœ„ ì°½ ë¦¬ë‹¤ì´ë ‰íŠ¸");
							$('#win95Window').hide();
							isIframeMode = true;
							window.location.href = '/';
							return; 
						}

						// iframe ë‚´ë¶€ ë¬¸ì„œì— ì ‘ê·¼
						const iframe = document.getElementById('windowContentFrame');
						const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

						// ë‚´ë¶€ ìŠ¤íƒ€ì¼ ì •ë¦¬
						if (iframeDoc && iframeDoc.body) {
							iframeDoc.body.style.overflow = 'hidden';
							iframeDoc.body.style.overflowX = 'hidden';
							iframeDoc.body.style.overflowY = 'hidden';
							iframeDoc.body.style.margin = '0';
							iframeDoc.body.style.padding = '0';

							const sidebars = iframeDoc.querySelectorAll('.sidebar, .sidebar-component');
							sidebars.forEach(sidebar => sidebar.style.display = 'none');

							const footers = iframeDoc.querySelectorAll('footer, .footer');
							footers.forEach(footer => footer.style.display = 'none');

							const mainContents = iframeDoc.querySelectorAll('.content-with-sidebar, main, #main');
							mainContents.forEach(content => {
								content.style.marginLeft = '0';
								content.style.width = '100%';
							});
						}

						// iframe ë‚´ ë§í¬ íƒ€ê²Ÿ ì„¤ì •
						let baseElement = iframeDoc.querySelector('base');
						if (!baseElement) {
							baseElement = iframeDoc.createElement('base');
							iframeDoc.head.appendChild(baseElement);
						}
						baseElement.setAttribute('target', '_self');

						const links = iframeDoc.querySelectorAll('a');
						links.forEach(link => {
							if (!link.hasAttribute('data-processed')) {
								link.addEventListener('click', function (e) {
									const href = this.getAttribute('href');
									if (href && requiresMainWindow(href)) {
										e.preventDefault();
										console.log('ğŸ”´ iframe ë‚´ë¶€ ë§í¬ë¥¼ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬:', href);
										window.parent.location.href = href;
									}
								});
								link.setAttribute('data-processed', 'true');
							}
						});

						console.log("iframe ë‚´ë¶€ ìš”ì†Œ ì •ë¦¬ ì™„ë£Œ");

						setTimeout(() => { isProcessing = false; }, 1000);

					} catch (e) {
						console.error("iframe ë‚´ë¶€ ìš”ì†Œ ì ‘ê·¼ ì˜¤ë¥˜:", e);
						isProcessing = false;
					}
				});

				// ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
				$('.win95-close').click(function () {
					$('#win95Window').hide();
					$('#windowContentFrame').attr('src', 'about:blank');
					window.history.pushState({ path: '/', mode: 'normal' }, '', '/');
					currentPath = '';
				});

				// ë“œë˜ê·¸ ê¸°ëŠ¥
				let isDragging = false;
				let offsetX, offsetY;
				$('.win95-title-bar').mousedown(function (e) {
					isDragging = true;
					offsetX = e.clientX - $('#win95Window').position().left;
					offsetY = e.clientY - $('#win95Window').position().top;

					$(document).mousemove(function (e) {
						if (isDragging) {
							$('#win95Window').css({
								left: e.clientX - offsetX,
								top: e.clientY - offsetY,
								transform: 'none'
							});
						}
					});

					$(document).mouseup(function () {
						isDragging = false;
						$(document).off('mousemove');
						$(document).off('mouseup');
					});
				});

				// í˜ì´ì§€ ë¡œë“œ ì‹œ URL ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
				const currentURL = window.location.pathname + window.location.search;
				if (currentURL !== '/' && !requiresMainWindow(currentURL)) {
					const title = 'ë¬¸ì„œ';
					openInIframe(currentURL, title);
				}
			});

			// --- ìœˆë„ìš° í¬ê¸° ì¡°ì • í•¨ìˆ˜ (ìµœì¢… ìˆ˜ì •) ---
			function adjustWindowSize() {
				const windowWidth = window.innerWidth;
				const windowHeight = window.innerHeight;
				const win95Window = $('#win95Window');
				const iframe = $('#windowContentFrame');

				// --- ìµœëŒ€ í¬ê¸° ì •ì˜ (ë„ˆë¹„ì™€ ë†’ì´ ëª¨ë‘ ê³ ì •) ---
				const maxIframeWidth = 1300;
				const maxIframeHeight = 580;
				const maxWindowWidth = maxIframeWidth + 20;   // ìœˆë„ìš° í…Œë‘ë¦¬(ì¢Œ/ìš° 10pxì”©) í¬í•¨
				const maxWindowHeight = maxIframeHeight + 40; // ìœˆë„ìš° ì œëª© í‘œì‹œì¤„ ë° í…Œë‘ë¦¬ í¬í•¨

				// ëª¨ë°”ì¼ ë·°ì—ì„œëŠ” ìœˆë„ìš°ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
				if (windowWidth < 768) {
					if (win95Window.is(':visible')) {
						win95Window.hide();
					}
					return;
				}

				// ìœˆë„ìš°ê°€ í™”ë©´ì— ë³´ì¼ ë•Œë§Œ í¬ê¸°ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.
				if (win95Window.is(':visible')) {
					
					// í™”ë©´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê³µê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤ (ì°½ ì£¼ë³€ ì—¬ë°± 100px í™•ë³´).
					const availableWidth = windowWidth - 100;
					const availableHeight = windowHeight - 100;

					// â˜…â˜…â˜… í•µì‹¬ ìˆ˜ì • ì‚¬í•­ â˜…â˜…â˜…
					// ëª©í‘œ ë„ˆë¹„ = min(ìµœëŒ€ ë„ˆë¹„, í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ë„ˆë¹„)
					// ëª©í‘œ ë†’ì´ = min(ìµœëŒ€ ë†’ì´, í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ë†’ì´)
					// ì´ë ‡ê²Œ í•˜ë©´ ì°½ í¬ê¸°ì™€ ê´€ê³„ì—†ì´ ë„ˆë¹„ì™€ ë†’ì´ ëª¨ë‘ ìµœëŒ€ê°’ì„ ì ˆëŒ€ ë„˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
					const targetWindowWidth = Math.min(maxWindowWidth, availableWidth);
					const targetWindowHeight = Math.min(maxWindowHeight, availableHeight);

					const targetIframeWidth = targetWindowWidth - 20;
					const targetIframeHeight = targetWindowHeight - 40;

					// ê³„ì‚°ëœ í¬ê¸°ì™€ ì¤‘ì•™ ì •ë ¬ ìœ„ì¹˜ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
					win95Window.css({
						'width': targetWindowWidth + 'px',
						'height': targetWindowHeight + 'px',
						'left': (windowWidth - targetWindowWidth) / 2 + 'px',
						'top': (windowHeight - targetWindowHeight) / 2 + 'px',
						'transform': 'none'
					});

					iframe.css({
						'width': targetIframeWidth + 'px',
						'height': targetIframeHeight + 'px',
						'overflow': 'hidden',
						'overflow-x': 'hidden',
						'overflow-y': 'hidden'
					});
				}
			}

			// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
			$(window).on('resize', adjustWindowSize);
			$(document).ready(adjustWindowSize);
			$(window).on('focus', adjustWindowSize);
		</script>
	</div>
</body>

</html>