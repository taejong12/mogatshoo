<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">

<head th:with="layoutTitle='ë¬¸ì˜í•˜ê¸°'">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		/* ğŸ”¥ ê¸°ì¡´ <style> íƒœê·¸ ë§¨ ìœ„ì— ì´ê²ƒë§Œ ì¶”ê°€ */

		/* Bootstrap ì¶©ëŒ ë°©ì§€ - ìµœì†Œí•œì˜ ìˆ˜ì • */
		html, body {
		    height: 100vh !important;
		    overflow: hidden !important;
		    margin: 0 !important;
		    padding: 0 !important;
		}

		/* Bootstrap ê°€ìƒìš”ì†Œ ì œê±° */
		body::before, body::after {
		    display: none !important;
		    content: none !important;
		}

		/* Bootstrap ë³€ìˆ˜ ë¬´ë ¥í™” */
		:root {
		    --bs-body-bg: #c0c0c0 !important;
		    --bs-body-color: #000000 !important;
		    --bs-body-font-family: 'MS Sans Serif', sans-serif !important;
		}

		/* ì±„íŒ… ì»¨í…Œì´ë„ˆ ìš°ì„ ìˆœìœ„ ë†’ì´ê¸° */
		.chat-container {
		    position: relative !important;
		    z-index: 1000 !important;
		}

		/* ê¸°ì¡´ CSSëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ ... */
        @font-face {
            font-family: 'dalmoori';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2102-01@1.0/dalmoori.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            background-color: #c0c0c0;
            border: 2px inset #c0c0c0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .chat-header {
            background-color: #008080;
            color: #ffffff;
            padding: 8px 12px;
            text-align: left;
            position: relative;
            border-bottom: 1px solid #404040;
            font-size: 15px;
            font-weight: bold;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 15px;
            font-weight: bold;
        }

        .chat-header .status {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .user-info {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 13px;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            background-color: #ffffff;
            border: 2px inset #c0c0c0;
            margin: 4px;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-end;
        }

        .message.mine {
            flex-direction: row-reverse;
        }

        .message.system {
            justify-content: center;
            margin: 12px 0;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            word-wrap: break-word;
            position: relative;
            font-size: 15px;
            color: #000000;
        }

        .message.mine .message-bubble {
            background-color: #000080;
            color: #ffffff;
            border: 2px outset #000080;
            margin-left: 8px;
        }

        .message.other .message-bubble {
            background-color: #c0c0c0;
            color: #000000;
            border: 2px outset #c0c0c0;
            margin-right: 8px;
        }

        .message.system .message-bubble {
            background-color: #ffffcc;
            border: 2px inset #c0c0c0;
            color: #000080;
            font-size: 13px;
            text-align: center;
            max-width: 90%;
            padding: 6px 12px;
            margin: 0;
        }

        .message-time {
            font-size: 11px;
            color: #808080;
            margin: 0 6px;
            align-self: flex-end;
        }

        .chat-input-container {
            padding: 8px;
            background-color: #c0c0c0;
            border-top: 1px solid #808080;
        }

        .connection-status {
            text-align: center;
            font-size: 13px;
            color: #808080;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .connection-status.connected {
            color: #008000;
        }

        .connection-status.disconnected {
            color: #800000;
        }

        .chat-input {
            display: flex;
            gap: 6px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px inset #c0c0c0;
            background-color: #ffffff;
            color: #000000;
            outline: none;
            font-size: 15px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .message-input:focus {
            background-color: #ffffff;
            border: 2px inset #c0c0c0;
        }

        .button-group {
            display: flex;
            flex-direction: row;
            gap: 4px;
        }

        .send-button, .end-chat-button {
            width: 50px;
            height: 40px;
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: bold;
        }

        .send-button:hover, .end-chat-button:hover {
            background-color: #d4d0c8;
            border: 2px outset #d4d0c8;
        }

        .send-button:active, .end-chat-button:active {
            border: 2px inset #c0c0c0;
            background-color: #a0a0a0;
        }

        .send-button:disabled, .end-chat-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #a0a0a0;
            border: 2px inset #c0c0c0;
        }

        .end-chat-button {
            background-color: #800000;
            color: #ffffff;
            border: 2px outset #800000;
        }

        .end-chat-button:hover {
            background-color: #a00000;
            border: 2px outset #a00000;
        }

        .end-chat-button:active {
            border: 2px inset #800000;
            background-color: #600000;
        }

        .chat-input-container.disabled {
            opacity: 0.7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #000080;
            font-size: 15px;
            font-weight: bold;
        }

        /* ìœˆë„ìš° 95 ìŠ¤íƒ€ì¼ ìŠ¤í¬ë¡¤ë°” */
        .chat-messages::-webkit-scrollbar {
            width: 16px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background-color: #c0c0c0;
            border: 1px solid #808080;
            box-shadow: inset 1px 1px 0 #dfdfdf, inset -1px -1px 0 #808080;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #c0c0c0;
            border: 1px solid #808080;
            box-shadow: 1px 1px 0 #dfdfdf, -1px -1px 0 #808080;
            min-height: 20px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: #d4d0c8;
        }

        .chat-messages::-webkit-scrollbar-thumb:active {
            background-color: #a0a0a0;
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #dfdfdf;
        }

        .chat-messages::-webkit-scrollbar-button {
            background-color: #c0c0c0;
            border: 1px solid #808080;
            box-shadow: 1px 1px 0 #dfdfdf, -1px -1px 0 #808080;
            width: 16px;
            height: 16px;
            display: block;
        }

        .chat-messages::-webkit-scrollbar-button:hover {
            background-color: #d4d0c8;
        }

        .chat-messages::-webkit-scrollbar-button:active {
            background-color: #a0a0a0;
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #dfdfdf;
        }

        /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°” í™”ì‚´í‘œ */
        .chat-messages::-webkit-scrollbar-button:vertical:start:decrement {
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 4l4 4H4z' fill='%23000'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }

        .chat-messages::-webkit-scrollbar-button:vertical:end:increment {
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 12l-4-4h8z' fill='%23000'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }

        @media (max-width: 480px) {
            .chat-container {
                width: 100%;
                height: 91vh;
            }
            
            .message-bubble {
                font-size: 15px;
            }
            
            .message-input {
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
	<div layout:fragment="content">
		<div class="chat-container">
			<div class="chat-header">
				<div class="user-info" id="userInfo">ì‚¬ìš©ì ì •ë³´ ë¡œë”©ì¤‘...</div>
				<h2>ëª¨ê°“ìŠˆ ë¬¸ì˜í•˜ê¸°</h2>
				<div class="status" id="connectionStatus">ì—°ê²° ì¤‘...</div>
			</div>
			
			<div class="chat-messages" id="messages">
				<div class="message other">
					<div class="message-bubble">
						ì•ˆë…•í•˜ì„¸ìš”! ëª¨ê°“ìŠˆ ê³ ê°ì§€ì›ì…ë‹ˆë‹¤.<br>
						ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜í•´ì£¼ì„¸ìš”.
					</div>
					<div class="message-time">ì§€ê¸ˆ</div>
				</div>
			</div>
			
			<div class="chat-input-container" id="inputContainer">
				<div class="connection-status" id="statusInfo">ì—°ê²° ì¤‘...</div>
				
				<div class="chat-input">
					<textarea class="message-input" id="messageInput" 
							 placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500"
							 rows="1"></textarea>
					<div class="button-group">
						<button class="send-button" id="sendButton" title="ë©”ì‹œì§€ ì „ì†¡">
							ì „ì†¡
						</button>
						<button class="end-chat-button" id="endChatButton" title="ì±„íŒ… ì¢…ë£Œ">
							ì¢…ë£Œ
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		<script>
		    // ğŸ”¥ ì¦‰ì‹œ ì‹¤í–‰ìœ¼ë¡œ DOM ì¤€ë¹„ í™•ì¸
		    (function() {
		        console.log('ğŸš€ ì±„íŒ… í˜ì´ì§€ ë¡œë”© ì‹œì‘');
		        
		        let stompClient = null;
		        let username = null;
		        let roomId = null;
		        let connected = false;
		        let isSubscribed = false;
		        let messageIds = new Set();
		        let chatEnded = false;
		        let initialized = false;

		        // ğŸ”¥ DOM ìš”ì†Œ í™•ì¸ í•¨ìˆ˜
		        function waitForElements() {
		            return new Promise((resolve) => {
		                function checkElements() {
		                    const elements = [
		                        document.getElementById('connectionStatus'),
		                        document.getElementById('statusInfo'),
		                        document.getElementById('messageInput'),
		                        document.getElementById('sendButton'),
		                        document.getElementById('endChatButton'),
		                        document.getElementById('messages'),
		                        document.getElementById('userInfo'),
		                        document.getElementById('inputContainer')
		                    ];
		                    
		                    const allReady = elements.every(el => el !== null);
		                    console.log('DOM ìš”ì†Œ ì²´í¬:', allReady ? 'âœ… ì™„ë£Œ' : 'âŒ ëŒ€ê¸°ì¤‘');
		                    
		                    if (allReady) {
		                        resolve(elements);
		                    } else {
		                        setTimeout(checkElements, 50);
		                    }
		                }
		                checkElements();
		            });
		        }

		        // ğŸ”¥ ë©”ì¸ ì´ˆê¸°í™” í•¨ìˆ˜
		        async function initialize() {
		            if (initialized) {
		                console.log('ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
		                return;
		            }
		            
		            try {
		                console.log('ğŸ“‹ ì´ˆê¸°í™” ì‹œì‘...');
		                
		                // 1. DOM ìš”ì†Œë“¤ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
		                const elements = await waitForElements();
		                console.log('âœ… DOM ìš”ì†Œë“¤ ì¤€ë¹„ ì™„ë£Œ');
		                
		                // 2. ì „ì—­ ë³€ìˆ˜ë¡œ DOM ìš”ì†Œë“¤ ì„¤ì •
		                window.chatElements = {
		                    connectionStatus: elements[0],
		                    statusInfo: elements[1],
		                    messageInput: elements[2],
		                    sendButton: elements[3],
		                    endChatButton: elements[4],
		                    messagesDiv: elements[5],
		                    userInfo: elements[6],
		                    inputContainer: elements[7]
		                };
		                
		                // 3. ì¦‰ì‹œ UI í™œì„±í™” (ì‚¬ìš©ìê°€ ë°”ë¡œ ë³¼ ìˆ˜ ìˆë„ë¡)
		                elements[1].textContent = 'ì—°ê²°ë¨';
		                elements[1].className = 'connection-status connected';
		                console.log('âœ… UI ì¦‰ì‹œ í™œì„±í™”');
		                
		                // 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
		                setupEventListeners();
		                console.log('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
		                
		                // 5. ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œ)
		                setTimeout(async () => {
		                    await loadUserInfo();
		                    setupRoomId();
		                    await loadChatHistory();
		                    connect();
		                }, 100);
		                
		                initialized = true;
		                console.log('ğŸ‰ ì´ˆê¸°í™” ì™„ë£Œ!');
		                
		            } catch (error) {
		                console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
		            }
		        }

		        // ğŸ”¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
		        function setupEventListeners() {
		            const { sendButton, endChatButton, messageInput } = window.chatElements;
		            
		            sendButton.addEventListener('click', sendMessage);
		            endChatButton.addEventListener('click', endChat);
		            
		            messageInput.addEventListener('keypress', function(e) {
		                if (e.key === 'Enter' && !e.shiftKey) {
		                    e.preventDefault();
		                    if (messageInput.value.trim()) {
		                        sendMessage();
		                    }
		                }
		            });

		            messageInput.addEventListener('input', function() {
		                // ìë™ í¬ê¸° ì¡°ì ˆ
		                messageInput.style.height = 'auto';
		                messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
		                
		                // ì±„íŒ… ì¢…ë£Œ ìƒíƒœ ì•ˆë‚´
		                if (chatEnded && messageInput.value.trim()) {
		                    window.chatElements.statusInfo.textContent = 'Enterë¥¼ ëˆ„ë¥´ë©´ ìƒˆë¡œìš´ ë¬¸ì˜ê°€ ì‹œì‘ë©ë‹ˆë‹¤.';
		                    window.chatElements.statusInfo.className = 'connection-status';
		                } else if (chatEnded) {
		                    window.chatElements.statusInfo.textContent = 'ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.';
		                    window.chatElements.statusInfo.className = 'connection-status disconnected';
		                }
		            });
		        }

		        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
		        async function loadUserInfo() {
		            try {
		                console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘...');
		                
		                // Thymeleaf ê°’ ì‹œë„
		                username = '[[${#authentication.name}]]' || null;
		                
		                if (!username || username === '[[${#authentication.name}]]' || username === 'anonymousUser') {
		                    // API í˜¸ì¶œ
		                    const response = await fetch('/qanda/api/user/info', {
		                        credentials: 'same-origin'
		                    });
		                    if (response.ok) {
		                        const userInfoData = await response.json();
		                        username = userInfoData.memberId;
		                    }
		                }
		                
		                if (!username) {
		                    username = 'guest_' + Date.now();
		                    window.chatElements.userInfo.textContent = 'ê²ŒìŠ¤íŠ¸';
		                } else {
		                    window.chatElements.userInfo.textContent = `${username}ë‹˜`;
		                }
		                
		                console.log('âœ… ì‚¬ìš©ì ì •ë³´:', username);
		                
		            } catch (error) {
		                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
		                username = 'guest_' + Date.now();
		                window.chatElements.userInfo.textContent = 'ê²ŒìŠ¤íŠ¸';
		            }
		        }

		        function setupRoomId() {
		            roomId = username;
		            console.log('ğŸ  Room ID ì„¤ì •:', roomId);
		        }

		        async function loadChatHistory() {
		            try {
		                console.log('ğŸ’¬ ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì¤‘...');
		                
		                const response = await fetch(`/qanda/api/rooms/${roomId}/messages`, {
		                    credentials: 'same-origin'
		                });
		                
		                if (response.ok) {
		                    const messages = await response.json();
		                    
		                    if (messages.length > 0) {
		                        window.chatElements.messagesDiv.innerHTML = '';
		                        
		                        messages.forEach(message => {
		                            displayMessage(message, false);
		                        });
		                        
		                        const lastMessage = messages[messages.length - 1];
		                        if (lastMessage.type === 'END') {
		                            chatEnded = true;
		                            disableChatInput('ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.');
		                        }
		                    }
		                }
		                
		                console.log('âœ… ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì™„ë£Œ');
		                
		            } catch (error) {
		                console.error('âŒ ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
		            }
		        }

		        function connect() {
		            if (stompClient && connected) {
		                console.log('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŒ');
		                return;
		            }
		            
		            console.log('ğŸ”Œ WebSocket ì—°ê²° ì¤‘...');
		            
		            const socket = new SockJS('/ws');
		            stompClient = Stomp.over(socket);
		            
		            stompClient.connect({}, function(frame) {
		                console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
		                connected = true;
		                updateConnectionStatus('ì—°ê²°ë¨', 'connected');
		                subscribeToRoom();
		            }, function(error) {
		                console.error('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
		                connected = false;
		                updateConnectionStatus('ì—°ê²° ì‹¤íŒ¨', 'disconnected');
		                
		                setTimeout(() => {
		                    if (!connected) {
		                        console.log('ğŸ”„ ì¬ì—°ê²° ì‹œë„...');
		                        connect();
		                    }
		                }, 5000);
		            });
		        }

		        function subscribeToRoom() {
		            if (!stompClient || !connected || !roomId || isSubscribed) return;
		            
		            try {
		                stompClient.subscribe('/topic/room.' + roomId, function(message) {
		                    const chatMessage = JSON.parse(message.body);
		                    
		                    if (displayMessage(chatMessage, true)) {
		                        if (chatMessage.sender === 'ê´€ë¦¬ì' && chatEnded) {
		                            chatEnded = false;
		                            enableChatInput();
		                        }
		                    }
		                });
		                
		                isSubscribed = true;
		                console.log('âœ… ë°© êµ¬ë… ì™„ë£Œ');
		                
		            } catch (error) {
		                console.error('âŒ êµ¬ë… ì‹¤íŒ¨:', error);
		            }
		        }

		        function sendMessage() {
		            const content = window.chatElements.messageInput.value.trim();
		            if (!content || !connected || !roomId) return;

		            if (chatEnded) {
		                const now = new Date();
		                const timeString = now.toLocaleString('ko-KR', {
		                    year: 'numeric', month: 'long', day: 'numeric',
		                    hour: '2-digit', minute: '2-digit'
		                });

		                const restartMessage = {
		                    type: 'RESTART',
		                    content: `---- ${timeString} ìƒˆë¡œìš´ ë¬¸ì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ ----`,
		                    sender: username, roomId: roomId,
		                    timestamp: new Date().getTime()
		                };

		                displayMessage(restartMessage, false);
		                stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(restartMessage));
		                
		                chatEnded = false;
		                enableChatInput();
		            }

		            window.chatElements.sendButton.disabled = true;
		            
		            const chatMessage = {
		                type: 'CHAT', content: content, sender: username,
		                roomId: roomId, timestamp: new Date().getTime()
		            };

		            try {
		                stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
		                window.chatElements.messageInput.value = '';
		                window.chatElements.messageInput.style.height = 'auto';
		            } catch (error) {
		                console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
		            } finally {
		                setTimeout(() => {
		                    if (!chatEnded) {
		                        window.chatElements.sendButton.disabled = false;
		                    }
		                }, 500);
		            }
		        }

		        function endChat() {
		            if (!connected || !roomId || chatEnded) return;

		            if (confirm('ì±„íŒ…ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
		                const now = new Date();
		                const timeString = now.toLocaleString('ko-KR', {
		                    year: 'numeric', month: 'long', day: 'numeric',
		                    hour: '2-digit', minute: '2-digit'
		                });

		                const endMessage = {
		                    type: 'END',
		                    content: `---- ${timeString} ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í–‰ë³µí•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ----`,
		                    sender: username, roomId: roomId,
		                    timestamp: new Date().getTime()
		                };

		                displayMessage(endMessage, false);
		                stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(endMessage));
		                
		                chatEnded = true;
		                disableChatInput('ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.');
		            }
		        }

		        function displayMessage(message, checkDuplicate = false) {
		            if (message.type === 'JOIN') return false;
		            
		            const messageId = message.timestamp || message.createdAt || (message.sender + message.content + Date.now());
		            
		            if (checkDuplicate && messageIds.has(messageId)) return false;
		            if (checkDuplicate) messageIds.add(messageId);
		            
		            const messageDiv = document.createElement('div');
		            
		            if (message.type === 'END' || message.type === 'RESTART') {
		                messageDiv.className = 'message system';
		                messageDiv.innerHTML = `<div class="message-bubble">${message.content}</div>`;
		            } else {
		                messageDiv.className = 'message ' + (message.sender === username ? 'mine' : 'other');
		                
		                const bubble = document.createElement('div');
		                bubble.className = 'message-bubble';
		                bubble.textContent = message.content;

		                const time = document.createElement('div');
		                time.className = 'message-time';
		                const messageTime = message.createdAt ? new Date(message.createdAt) : new Date();
		                time.textContent = messageTime.toLocaleTimeString('ko-KR', {
		                    hour: '2-digit', minute: '2-digit'
		                });

		                messageDiv.appendChild(bubble);
		                messageDiv.appendChild(time);
		            }
		            
		            window.chatElements.messagesDiv.appendChild(messageDiv);
		            window.chatElements.messagesDiv.scrollTop = window.chatElements.messagesDiv.scrollHeight;
		            
		            return true;
		        }

		        function disableChatInput(message) {
		            window.chatElements.sendButton.disabled = true;
		            window.chatElements.endChatButton.disabled = true;
		            window.chatElements.statusInfo.textContent = message;
		            window.chatElements.statusInfo.className = 'connection-status disconnected';
		        }

		        function enableChatInput() {
		            window.chatElements.messageInput.disabled = false;
		            window.chatElements.sendButton.disabled = false;
		            window.chatElements.endChatButton.disabled = false;
		            
		            if (connected) {
		                window.chatElements.statusInfo.textContent = 'ì—°ê²°ë¨';
		                window.chatElements.statusInfo.className = 'connection-status connected';
		            }
		        }

		        function updateConnectionStatus(text, className) {
		            window.chatElements.connectionStatus.textContent = text;
		            
		            if (!chatEnded) {
		                window.chatElements.statusInfo.textContent = text;
		                window.chatElements.statusInfo.className = 'connection-status ' + className;
		            }
		        }

		        // ğŸ”¥ ì—¬ëŸ¬ ì‹œì ì—ì„œ ì´ˆê¸°í™” ì‹œë„
		        // 1. DOMì´ ì¤€ë¹„ë˜ëŠ” ì¦‰ì‹œ
		        if (document.readyState === 'loading') {
		            document.addEventListener('DOMContentLoaded', initialize);
		        } else {
		            // ì´ë¯¸ DOMì´ ì¤€ë¹„ë¨
		            setTimeout(initialize, 50);
		        }
		        
		        // 2. ì™„ì „ ë¡œë“œ í›„ì—ë„ ì‹œë„ (ë°±ì—…)
		        window.addEventListener('load', function() {
		            setTimeout(function() {
		                if (!initialized) {
		                    console.log('ğŸ”„ ë°±ì—… ì´ˆê¸°í™” ì‹¤í–‰');
		                    initialize();
		                }
		            }, 100);
		        });
		        
		        // 3. í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
		        window.addEventListener('beforeunload', function() {
		            if (stompClient) {
		                stompClient.disconnect();
		            }
		        });

		    })(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë
		</script>
	</div>
</body>
</html>