<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
</head>

<body>
	<!-- ë‹¤ë¥¸ í˜ì´ì§€ì— í¬í•¨ë  ì‚¬ì´ë“œë°” ì¡°ê° -->
	<div th:fragment="sidebar" class="sidebar-component">
		<div class="sidebar">
			<!-- ë¡œê³  ì˜ì—­ -->
			<div class="sidebar-logo">
				<a th:href="@{/voting}">
					<div class="menu-icon">
						<img src="/img/icons/computer.png" alt="mogatshoo" class="logo-img">
					</div>
					<div class="logo-text">íƒˆëª¨ì™•ì¤‘ì™•</div>
				</a>
			</div>

			<!-- ë©”ë‰´ ì•„ì´í…œ -->
			<div class="sidebar-menu">
				<div class="menu-item">
					<a class="nav-link" th:href="@{/}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="í™ˆ">
						</div>
						<span class="menu-text">í™ˆ</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/fortune/start}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="ìš´ì„¸">
						</div>
						<span class="menu-text">ì˜¤ëŠ˜ìš´ì„¸</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hairLossTest/testHair}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="íƒˆëª¨ì§„ë‹¨">
						</div>
						<span class="menu-text">íƒˆëª¨ì§„ë‹¨</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/hospitalMap/hospitals}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="ë³‘ì›ì§€ë„">
						</div>
						<span class="menu-text">ë³‘ì›ì§€ë„</span>
					</a>
				</div>
				<div class="menu-item">
					<a class="nav-link" th:href="@{/point/shop/list}">
						<div class="menu-icon">
							<img src="/img/icons/computer.png" alt="í¬ì¸íŠ¸ìƒµ">
						</div>
						<span class="menu-text">í¬ì¸íŠ¸ìƒµ</span>
					</a>
				</div>
			</div>

			<!-- í† ê¸€ ë²„íŠ¼ (ëª¨ë°”ì¼ ë·°ì—ì„œë§Œ ë³´ì„) -->
			<div class="sidebar-toggle">
				<button id="sidebarToggleBtn">
					<span class="toggle-icon">â˜°</span>
				</button>
			</div>
		</div>

		<!-- ìœˆë„ìš°95 ì°½ í…œí”Œë¦¿ -->
		<div id="win95Window" class="win95-window">
			<div class="win95-title-bar">
				<div class="win95-title-text">ë¬¸ì„œ</div>
				<div class="win95-close">Ã—</div>
			</div>
			<div class="win95-content">
				<iframe id="windowContentFrame" style="width:1300px; height:580px; border:none; overflow-x: hidden;"
					src="about:blank"></iframe>
			</div>
		</div>

		<!-- jQuery ì‚¬ìš© (ê°„í¸í•œ Ajax ì²˜ë¦¬ë¥¼ ìœ„í•´) -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<script>
			console.log("ğŸš€ ì‚¬ì´ë“œë°” ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - ìƒˆ ë²„ì „!");

			$(document).ready(function () {
				// í˜„ì¬ ëª¨ë“œ ìƒíƒœ ê´€ë¦¬
				let isIframeMode = true;
				let currentPath = '';

				// URL ë™ê¸°í™” í•¨ìˆ˜
				function updateBrowserURL(path) {
					if (path && path !== '/') {
						// History APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì € URL ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
						window.history.pushState({path: path, mode: 'iframe'}, '', path);
						currentPath = path;
					}
				}

				// ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
				window.addEventListener('popstate', function (event) {
					if (event.state) {
						if (event.state.mode === 'iframe' && event.state.path) {
							// iframe ëª¨ë“œë¡œ í•´ë‹¹ ê²½ë¡œ ë¡œë“œ
							openInIframe(event.state.path, 'ë¬¸ì„œ');
						} else {
							// ì¼ë°˜ í˜ì´ì§€ ì´ë™
							window.location.href = event.state.path || '/';
						}
					}
				});

				// ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê²½ë¡œë“¤ (ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬)
				const loginRequiredPaths = [
					'/login',
					'/member/login',
					'/member/join',          // íšŒì›ê°€ì…
					'/oauth2/authorization/',  // ì†Œì…œ ë¡œê·¸ì¸ë„ ë©”ì¸ ìœˆë„ìš°ì—ì„œ
					'/oauth2/join',
					'/logout'
				];

				// ë¡œê·¸ì¸ ê²½ë¡œ ì²´í¬ (ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬)
				function requiresMainWindow(path) {
					return loginRequiredPaths.some(loginPath => path.includes(loginPath));
				}

				// iframeì—ì„œ ì½˜í…ì¸  ë¡œë“œ í•¨ìˆ˜
				function openInIframe(file, title) {
					console.log('iframeì—ì„œ ë¡œë“œ:', file);

					// ìœˆë„ìš° ì œëª© ì„¤ì •
					$('.win95-title-text').text(title);

					// ìœˆë„ìš° í‘œì‹œ ë° ìœ„ì¹˜ ì„¤ì •
					$('#win95Window').css({
						'display': 'block',
						'position': 'fixed',
						'left': '150px',
						'top': '50px',
						'transform': 'none'
					});

					// iframe ì†ŒìŠ¤ ì„¤ì •
					$('#windowContentFrame').attr('src', file);

					// URL ë™ê¸°í™”
					updateBrowserURL(file);
				}

				// ë©”ì¸ ìœˆë„ìš°ì—ì„œ í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜ (ë¡œê·¸ì¸ìš©)
				function openInMainWindow(file) {
					console.log('ë©”ì¸ ìœˆë„ìš°ì—ì„œ ë¡œë“œ:', file);
					isIframeMode = false;

					// í˜„ì¬ ì°½ì—ì„œ ì§ì ‘ ì´ë™
					window.location.href = file;
				}

				// ì‚¬ì´ë“œë°” í•­ëª© í´ë¦­ ì‹œ
				$('.menu-item a, .auth-item a, .auth-profile a').click(function (e) {
					// ğŸš¨ í‘¸í„° ë§í¬ëŠ” ì œì™¸ (í‘¸í„°ì—ì„œ ë³„ë„ ì²˜ë¦¬)
					if ($(this).hasClass('footer-link')) {
						return; // í‘¸í„° ë§í¬ëŠ” ì‚¬ì´ë“œë°”ì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
					}

					e.preventDefault(); // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€

					// í´ë¦­ëœ ë§í¬ì˜ href ì†ì„±ì—ì„œ íŒŒì¼ ê²½ë¡œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
					const file = $(this).attr('href');
					// ë©”ë‰´ í…ìŠ¤íŠ¸ì—ì„œ ì°½ì˜ ì œëª©ì„ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ 'ë¬¸ì„œ'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
					const title = $(this).find('.menu-text').text() || 'ë¬¸ì„œ';

					console.log('ì‚¬ì´ë“œë°” ë§í¬ í´ë¦­:', file, title);

					// '/' ë§í¬ëŠ” ì¼ë°˜ì ì¸ í˜ì´ì§€ ì´ë™ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
					if (file === '/') {
						window.location.href = file;
						return;
					}

					// ğŸš¨ íšŒì›ê°€ì…/ë¡œê·¸ì¸/ì†Œì…œë¡œê·¸ì¸ ë§í¬ëŠ” iframeì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
					if (file.includes('/member/join') ||
						file.includes('/member/login') ||
						file.includes('/login') ||
						file.includes('/oauth2/') ||
						file.includes('/logout')) {

						console.log('ğŸ”´ ë¡œê·¸ì¸/íšŒì›ê°€ì…/ì†Œì…œë¡œê·¸ì¸ì€ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬:', file);

						// iframe ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸°
						$('#win95Window').hide();
						$('#windowContentFrame').attr('src', 'about:blank');

						// ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì§ì ‘ ì´ë™
						window.location.href = file;
						return;
					}

					// ì¼ë°˜ í˜ì´ì§€ë§Œ iframeì—ì„œ ì²˜ë¦¬
					console.log('ğŸ”µ iframeì—ì„œ ì²˜ë¦¬:', file);
					openInIframe(file, title);
				});

				// iframe ë¡œë“œ ì™„ë£Œ í›„ ì²˜ë¦¬ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
				let isProcessing = false;
				$('#windowContentFrame').off('load').on('load', function () {
					// ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
					if (isProcessing) {
						console.log("âš ï¸ ì´ë¯¸ ì²˜ë¦¬ ì¤‘, ë¬´ì‹œ");
						return;
					}

					try {
						// iframeì˜ í˜„ì¬ URL ê°€ì ¸ì˜¤ê¸°
						const iframeURL = this.contentWindow.location.href;
						const currentHost = window.location.host; // í˜„ì¬ ë„ë©”ì¸

						console.log("=== iframe load ì´ë²¤íŠ¸ ===");
						console.log("iframe í˜„ì¬ URL:", iframeURL);
						console.log("ì‹œê°„:", new Date().toLocaleTimeString());

						// about:blankëŠ” ë¬´ì‹œ
						if (iframeURL === 'about:blank' || iframeURL === '') {
							console.log("about:blank ë¬´ì‹œ");
							return;
						}

						// ğŸš¨ ë¡œê·¸ì¸ í˜ì´ì§€ì¸ì§€ ë¨¼ì € ì²´í¬
						if (iframeURL.indexOf('/member/login') !== -1) {
							console.log("ğŸ”´ ë¡œê·¸ì¸ í˜ì´ì§€ ê°ì§€ë¨! ì²˜ë¦¬ ì‹œì‘");
							isProcessing = true; // ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸

							// iframe ì¦‰ì‹œ ì •ë¦¬
							$('#win95Window').hide();
							$('#windowContentFrame').attr('src', 'about:blank');

							// ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì¦‰ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
							console.log("ğŸš€ ë©”ì¸ ìœˆë„ìš°ë¡œ ê°•ì œ ì´ë™");

							// ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„
							try {
								window.top.location.href = '/member/login';
							} catch (e) {
								try {
									parent.location.href = '/member/login';
								} catch (e2) {
									window.location.href = '/member/login';
								}
							}

							return; // ì´í›„ ëª¨ë“  ì²˜ë¦¬ ì¤‘ë‹¨
						}

						// URL ë™ê¸°í™” (iframe ë‚´ì—ì„œ ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ì´ ë°œìƒí•œ ê²½ìš°)
						if (iframeURL.includes(`//${currentHost}/`) && !iframeURL.endsWith('about:blank')) {
							const path = new URL(iframeURL).pathname + new URL(iframeURL).search;
							if (path !== currentPath && path !== '/') {
								updateBrowserURL(path);
							}
						}

						// ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²½ìš° (ë¡œê·¸ì¸ ì„±ê³µ í›„ ë“±)
						if (iframeURL.includes(`//${currentHost}/`) && // ë™ì¼ ë„ë©”ì¸ì˜ ë£¨íŠ¸ ê²½ë¡œ
							(iframeURL.endsWith('/') ||
								iframeURL.endsWith('/index.html') ||
								iframeURL.includes('/index') ||
								iframeURL.endsWith('/home') ||
								iframeURL.includes('login?success') ||
								iframeURL.includes('?success') ||
								iframeURL.includes('?loginSuccess'))) {

							console.log("ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ ê°ì§€ë¨, ì°½ ë‹«ê³  ìµœìƒìœ„ ì°½ ë¦¬ë‹¤ì´ë ‰íŠ¸");

							// ìœˆë„ìš° ì°½ ìˆ¨ê¸°ê¸°
							$('#win95Window').hide();

							// iframe ëª¨ë“œ ì¬í™œì„±í™”
							isIframeMode = true;

							// ë¶€ëª¨ ì°½ì—ì„œ ë©”ì¸ìœ¼ë¡œ ì´ë™
							window.location.href = '/';
							return; // ì´í›„ ì½”ë“œ ì‹¤í–‰ ì¤‘ì§€
						}

						// iframe ë‚´ë¶€ ë¬¸ì„œì— ì ‘ê·¼
						const iframe = document.getElementById('windowContentFrame');
						const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

						// ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê¸° (ë‹¤ì–‘í•œ ì„ íƒì ì‹œë„)
						const sidebars = iframeDoc.querySelectorAll('.sidebar, .sidebar-component, .side-nav, #sidebar, nav[role="navigation"]');
						sidebars.forEach(sidebar => {
							if (sidebar) sidebar.style.display = 'none';
						});

						// í‘¸í„° ìˆ¨ê¸°ê¸° (ë‹¤ì–‘í•œ ì„ íƒì ì‹œë„)
						const footers = iframeDoc.querySelectorAll('footer, .footer, .site-footer, #footer');
						footers.forEach(footer => {
							if (footer) footer.style.display = 'none';
						});

						// ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ì— ì „ì²´ ë„ˆë¹„ ì ìš©
						const mainContents = iframeDoc.querySelectorAll('.content-with-sidebar, main, #main, .main-content');
						mainContents.forEach(content => {
							if (content) {
								content.style.marginLeft = '0';
								content.style.width = '100%';
							}
						});

						// bodyì— ì§ì ‘ ìŠ¤íƒ€ì¼ ì ìš©
						if (iframeDoc.body) {
							iframeDoc.body.style.margin = '0';
							iframeDoc.body.style.padding = '0';
						}

						// base íƒœê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  target ì„¤ì •
						let baseElement = iframeDoc.querySelector('base');
						if (!baseElement) {
							baseElement = iframeDoc.createElement('base');
							iframeDoc.head.appendChild(baseElement);
						}
						baseElement.setAttribute('target', '_self');

						// iframe ë‚´ ë§í¬ë“¤ì„ iframe ë‚´ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ì„¤ì •
						const links = iframeDoc.querySelectorAll('a');
						links.forEach(link => {
							if (!link.hasAttribute('data-processed')) {
								link.addEventListener('click', function (e) {
									const href = this.getAttribute('href');

									// ë¡œê·¸ì¸/íšŒì›ê°€ì…/ì†Œì…œë¡œê·¸ì¸ ê´€ë ¨ ë§í¬ëŠ” ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬
									if (href && (href.includes('/member/join') ||
										href.includes('/member/login') ||
										href.includes('/login') ||
										href.includes('/oauth2/') ||
										href.includes('/logout'))) {
										e.preventDefault();
										console.log('ğŸ”´ iframe ë‚´ë¶€ ë§í¬ë¥¼ ë©”ì¸ ìœˆë„ìš°ì—ì„œ ì²˜ë¦¬:', href);
										// ë¶€ëª¨ ìœˆë„ìš°ì—ì„œ ë¡œê·¸ì¸/íšŒì›ê°€ì…/ì†Œì…œë¡œê·¸ì¸ ì²˜ë¦¬
										window.parent.location.href = href;
									}
								});
								link.setAttribute('data-processed', 'true');
							}
						});

						console.log("iframe ë‚´ë¶€ ìš”ì†Œ ì •ë¦¬ ì™„ë£Œ");

						// ì²˜ë¦¬ ì™„ë£Œ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
						setTimeout(() => {
							isProcessing = false;
						}, 1000);

					} catch (e) {
						console.error("iframe ë‚´ë¶€ ìš”ì†Œ ì ‘ê·¼ ì˜¤ë¥˜:", e);
						isProcessing = false; // ì—ëŸ¬ ì‹œì—ë„ í”Œë˜ê·¸ ë¦¬ì…‹
					}
				});

				// ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
				$('.win95-close').click(function () {
					$('#win95Window').hide();
					// iframe ë‚´ìš© ì œê±°
					$('#windowContentFrame').attr('src', 'about:blank');

					// URLì„ í™ˆìœ¼ë¡œ ë³µì›
					window.history.pushState({path: '/', mode: 'normal'}, '', '/');
					currentPath = '';
				});

				// ë“œë˜ê·¸ ê¸°ëŠ¥
				let isDragging = false;
				let offsetX, offsetY;

				$('.win95-title-bar').mousedown(function (e) {
					isDragging = true;
					offsetX = e.clientX - $('#win95Window').position().left;
					offsetY = e.clientY - $('#win95Window').position().top;

					$(document).mousemove(function (e) {
						if (isDragging) {
							$('#win95Window').css({
								left: e.clientX - offsetX,
								top: e.clientY - offsetY,
								transform: 'none'
							});
						}
					});

					$(document).mouseup(function () {
						isDragging = false;
						$(document).off('mousemove');
						$(document).off('mouseup');
					});
				});

				// í˜ì´ì§€ ë¡œë“œ ì‹œ URL ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
				const currentURL = window.location.pathname + window.location.search;
				if (currentURL !== '/' && !requiresMainWindow(currentURL)) {
					// ì§ì ‘ URLë¡œ ì ‘ê·¼í•œ ê²½ìš° iframeìœ¼ë¡œ í•´ë‹¹ í˜ì´ì§€ ë¡œë“œ
					const title = 'ë¬¸ì„œ'; // ë˜ëŠ” í˜ì´ì§€ë³„ ì œëª© ë§¤í•‘
					openInIframe(currentURL, title);
				}
			});
		</script>
	</div>
</body>

</html>