<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">

<head th:with="layoutTitle='ë¬¸ì˜í•˜ê¸°'">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
        @font-face {
            font-family: 'dalmoori';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2102-01@1.0/dalmoori.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            background-color: #c0c0c0;
            border: 2px inset #c0c0c0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .chat-header {
            background-color: #008080;
            color: #ffffff;
            padding: 8px 12px;
            text-align: left;
            position: relative;
            border-bottom: 1px solid #404040;
            font-size: 15px;
            font-weight: bold;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 15px;
            font-weight: bold;
        }

        .chat-header .status {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .user-info {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 13px;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            background-color: #ffffff;
            border: 2px inset #c0c0c0;
            margin: 4px;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-end;
        }

        .message.mine {
            flex-direction: row-reverse;
        }

        .message.system {
            justify-content: center;
            margin: 12px 0;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            word-wrap: break-word;
            position: relative;
            font-size: 15px;
            color: #000000;
        }

        .message.mine .message-bubble {
            background-color: #000080;
            color: #ffffff;
            border: 2px outset #000080;
            margin-left: 8px;
        }

        .message.other .message-bubble {
            background-color: #c0c0c0;
            color: #000000;
            border: 2px outset #c0c0c0;
            margin-right: 8px;
        }

        .message.system .message-bubble {
            background-color: #ffffcc;
            border: 2px inset #c0c0c0;
            color: #000080;
            font-size: 13px;
            text-align: center;
            max-width: 90%;
            padding: 6px 12px;
            margin: 0;
        }

        .message-time {
            font-size: 11px;
            color: #808080;
            margin: 0 6px;
            align-self: flex-end;
        }

        .chat-input-container {
            padding: 8px;
            background-color: #c0c0c0;
            border-top: 1px solid #808080;
        }

        .connection-status {
            text-align: center;
            font-size: 13px;
            color: #808080;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .connection-status.connected {
            color: #008000;
        }

        .connection-status.disconnected {
            color: #800000;
        }

        .chat-input {
            display: flex;
            gap: 6px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px inset #c0c0c0;
            background-color: #ffffff;
            color: #000000;
            outline: none;
            font-size: 15px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .message-input:focus {
            background-color: #ffffff;
            border: 2px inset #c0c0c0;
        }

        .button-group {
            display: flex;
            flex-direction: row;
            gap: 4px;
        }

        .send-button, .end-chat-button {
            width: 50px;
            height: 40px;
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: bold;
        }

        .send-button:hover, .end-chat-button:hover {
            background-color: #d4d0c8;
            border: 2px outset #d4d0c8;
        }

        .send-button:active, .end-chat-button:active {
            border: 2px inset #c0c0c0;
            background-color: #a0a0a0;
        }

        .send-button:disabled, .end-chat-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #a0a0a0;
            border: 2px inset #c0c0c0;
        }

        .end-chat-button {
            background-color: #800000;
            color: #ffffff;
            border: 2px outset #800000;
        }

        .end-chat-button:hover {
            background-color: #a00000;
            border: 2px outset #a00000;
        }

        .end-chat-button:active {
            border: 2px inset #800000;
            background-color: #600000;
        }

        .chat-input-container.disabled {
            opacity: 0.7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #000080;
            font-size: 15px;
            font-weight: bold;
        }

        /* ìœˆë„ìš° 95 ìŠ¤íƒ€ì¼ ìŠ¤í¬ë¡¤ë°” */
        .chat-messages::-webkit-scrollbar {
            width: 16px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background-color: #c0c0c0;
            border: 1px solid #808080;
            box-shadow: inset 1px 1px 0 #dfdfdf, inset -1px -1px 0 #808080;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #c0c0c0;
            border: 1px solid #808080;
            box-shadow: 1px 1px 0 #dfdfdf, -1px -1px 0 #808080;
            min-height: 20px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: #d4d0c8;
        }

        .chat-messages::-webkit-scrollbar-thumb:active {
            background-color: #a0a0a0;
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #dfdfdf;
        }

        .chat-messages::-webkit-scrollbar-button {
            background-color: #c0c0c0;
            border: 1px solid #808080;
            box-shadow: 1px 1px 0 #dfdfdf, -1px -1px 0 #808080;
            width: 16px;
            height: 16px;
            display: block;
        }

        .chat-messages::-webkit-scrollbar-button:hover {
            background-color: #d4d0c8;
        }

        .chat-messages::-webkit-scrollbar-button:active {
            background-color: #a0a0a0;
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #dfdfdf;
        }

        /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°” í™”ì‚´í‘œ */
        .chat-messages::-webkit-scrollbar-button:vertical:start:decrement {
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 4l4 4H4z' fill='%23000'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }

        .chat-messages::-webkit-scrollbar-button:vertical:end:increment {
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 12l-4-4h8z' fill='%23000'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }

        @media (max-width: 480px) {
            .chat-container {
                width: 100%;
                height: 100vh;
            }
            
            .message-bubble {
                font-size: 15px;
            }
            
            .message-input {
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
	<div layout:fragment="content">
		<div class="chat-container">
			<div class="chat-header">
				<div class="user-info" id="userInfo">ì‚¬ìš©ì ì •ë³´ ë¡œë”©ì¤‘...</div>
				<h2>ëª¨ê°“ìŠˆ ë¬¸ì˜í•˜ê¸°</h2>
				<div class="status" id="connectionStatus">ì—°ê²° ì¤‘...</div>
			</div>
			
			<div class="chat-messages" id="messages">
				<div class="message other">
					<div class="message-bubble">
						ì•ˆë…•í•˜ì„¸ìš”! ëª¨ê°“ìŠˆ ê³ ê°ì§€ì›ì…ë‹ˆë‹¤.<br>
						ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜í•´ì£¼ì„¸ìš”.
					</div>
					<div class="message-time">ì§€ê¸ˆ</div>
				</div>
			</div>
			
			<div class="chat-input-container" id="inputContainer">
				<div class="connection-status" id="statusInfo">ì—°ê²° ì¤‘...</div>
				
				<div class="chat-input">
					<textarea class="message-input" id="messageInput" 
							 placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500"
							 rows="1"></textarea>
					<div class="button-group">
						<button class="send-button" id="sendButton" title="ë©”ì‹œì§€ ì „ì†¡">
							ì „ì†¡
						</button>
						<button class="end-chat-button" id="endChatButton" title="ì±„íŒ… ì¢…ë£Œ">
							ì¢…ë£Œ
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		
		<script>
			let stompClient = null;
			let username = null;
			let roomId = null;
			let connected = false;
			let isSubscribed = false;
			let messageIds = new Set();
			let chatEnded = false; // ì±„íŒ… ì¢…ë£Œ ìƒíƒœ

			const connectionStatus = document.getElementById('connectionStatus');
			const statusInfo = document.getElementById('statusInfo');
			const messageInput = document.getElementById('messageInput');
			const sendButton = document.getElementById('sendButton');
			const endChatButton = document.getElementById('endChatButton');
			const messagesDiv = document.getElementById('messages');
			const userInfo = document.getElementById('userInfo');
			const inputContainer = document.getElementById('inputContainer');

			// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
			window.addEventListener('load', async function() {
				console.log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
				
				await loadUserInfo();
				setupRoomId();
				await loadChatHistory();
				connect();
				setupEventListeners();
			});

			// ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
			async function loadUserInfo() {
				try {
					username = '[[${#authentication.name}]]' || null;
					
					if (!username || username === '[[${#authentication.name}]]') {
						const response = await fetch('/qanda/api/user/info', {
							credentials: 'same-origin'
						});
						if (response.ok) {
							const userInfoData = await response.json();
							username = userInfoData.memberId;
						}
					}
					
					if (!username) {
						username = 'guest_' + Date.now();
						userInfo.textContent = 'ê²ŒìŠ¤íŠ¸';
					} else {
						userInfo.textContent = `${username}ë‹˜`;
					}
					
					console.log('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì™„ë£Œ:', username);
					
				} catch (error) {
					console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
					username = 'guest_' + Date.now();
					userInfo.textContent = 'ê²ŒìŠ¤íŠ¸';
				}
			}

			// ë°© ID ì„¤ì •
			function setupRoomId() {
				roomId = username; // member IDë¥¼ ë°© IDë¡œ ì‚¬ìš©
				console.log('Room ID ì„¤ì •:', roomId);
			}

			// ì±„íŒ… ë‚´ì—­ ë¡œë“œ (ğŸ”¥ ìˆ˜ì •ëœ ë²„ì „)
			async function loadChatHistory() {
				try {
					console.log('ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì‹œì‘...');
					
					const response = await fetch(`/qanda/api/rooms/${roomId}/messages`, {
						credentials: 'same-origin'
					});
					
					if (response.ok) {
						const messages = await response.json();
						console.log('ë¡œë“œëœ ë©”ì‹œì§€ ìˆ˜:', messages.length);
						
						// ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ í™˜ì˜ ë©”ì‹œì§€ ì œê±°í•˜ê³  ì‹¤ì œ ë©”ì‹œì§€ë“¤ í‘œì‹œ
						if (messages.length > 0) {
							messagesDiv.innerHTML = '';
							
							// ë©”ì‹œì§€ë“¤ í‘œì‹œ
							messages.forEach(message => {
								displayMessage(message, false);
							});
							
							// ğŸ”¥ ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ì±„íŒ… ì¢…ë£Œ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
							const lastMessage = messages[messages.length - 1];
							if (lastMessage.type === 'END') {
								console.log('ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ì¢…ë£Œ ë©”ì‹œì§€ - ì¢…ë£Œ ìƒíƒœ ìœ ì§€');
								chatEnded = true;
								disableChatInput('ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.');
							}
						} else {
							// ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ í™˜ì˜ ë©”ì‹œì§€ ìœ ì§€
							console.log('ê¸°ì¡´ ì±„íŒ… ë‚´ì—­ ì—†ìŒ - í™˜ì˜ ë©”ì‹œì§€ ìœ ì§€');
						}
					} else {
						console.log('ê¸°ì¡´ ì±„íŒ… ë‚´ì—­ ì—†ìŒ');
					}
					
				} catch (error) {
					console.error('ì±„íŒ… ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
				}
			}

			// ì›¹ì†Œì¼“ ì—°ê²°
			function connect() {
				if (stompClient && connected) {
					console.log('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŒ');
					return;
				}
				
				const socket = new SockJS('/ws');
				stompClient = Stomp.over(socket);
				
				stompClient.connect({}, function(frame) {
					console.log('Connected: ' + frame);
					connected = true;
					updateConnectionStatus('ì—°ê²°ë¨', 'connected');
					
					subscribeToRoom();
					
				}, function(error) {
					console.log('Connection error: ' + error);
					connected = false;
					isSubscribed = false;
					updateConnectionStatus('ì—°ê²° ì‹¤íŒ¨', 'disconnected');
					
					setTimeout(() => {
						if (!connected) {
							console.log('ì¬ì—°ê²° ì‹œë„...');
							connect();
						}
					}, 5000);
				});
			}

			// ë°© êµ¬ë…
			function subscribeToRoom() {
				if (!stompClient || !connected || !roomId || isSubscribed) {
					console.log('êµ¬ë… ì¡°ê±´ ë¯¸ì¶©ì¡±');
					return;
				}
				
				console.log('ë°© êµ¬ë… ì‹œì‘:', roomId);
				
				try {
					stompClient.subscribe('/topic/room.' + roomId, function(message) {
						console.log('WebSocket ë©”ì‹œì§€ ë°›ìŒ:', message.body);
						const chatMessage = JSON.parse(message.body);
						
						if (displayMessage(chatMessage, true)) {
							// ê´€ë¦¬ì ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì±„íŒ… ì¢…ë£Œ ìƒíƒœ í•´ì œ
							if (chatMessage.sender === 'ê´€ë¦¬ì' && chatEnded) {
								chatEnded = false;
								enableChatInput();
							}
						}
					});
					
					isSubscribed = true;
					console.log('ë°© êµ¬ë… ì™„ë£Œ');
					
				} catch (error) {
					console.error('êµ¬ë… ì¤‘ ì˜¤ë¥˜:', error);
					isSubscribed = false;
				}
			}

			// ë©”ì‹œì§€ ì „ì†¡
			function sendMessage() {
				const content = messageInput.value.trim();
				if (!content) return;
				
				console.log('ë©”ì‹œì§€ ì „ì†¡ ì‹œë„ - ì±„íŒ… ì¢…ë£Œ ìƒíƒœ:', chatEnded);
				
				if (!connected || !roomId) {
					alert('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
					return;
				}

				// ì±„íŒ…ì´ ì¢…ë£Œëœ ìƒíƒœì—ì„œ ìƒˆ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ì¬ì‹œì‘ ë©”ì‹œì§€ ë¨¼ì € ì „ì†¡
				if (chatEnded) {
					console.log('ì±„íŒ… ì¬ì‹œì‘!');
					
					// ì¬ì‹œì‘ ë©”ì‹œì§€ ìƒì„±
					const now = new Date();
					const timeString = now.toLocaleString('ko-KR', {
						year: 'numeric',
						month: 'long',
						day: 'numeric',
						hour: '2-digit',
						minute: '2-digit'
					});

					const restartMessage = {
						type: 'RESTART',
						content: `---- ${timeString} ìƒˆë¡œìš´ ë¬¸ì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ ----`,
						sender: username,
						roomId: roomId,
						timestamp: new Date().getTime()
					};

					// ì¬ì‹œì‘ ë©”ì‹œì§€ ë¡œì»¬ í‘œì‹œ ë° ì„œë²„ ì „ì†¡
					displayMessage(restartMessage, false);
					stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(restartMessage));
					
					chatEnded = false;
					enableChatInput();
				}

				sendButton.disabled = true;
				
				const chatMessage = {
					type: 'CHAT',
					content: content,
					sender: username,
					roomId: roomId,
					timestamp: new Date().getTime()
				};

				console.log('ì „ì†¡í•  ë©”ì‹œì§€:', chatMessage);
				
				try {
					stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
					messageInput.value = '';
					autoResizeTextarea();
				} catch (error) {
					console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
					alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				} finally {
					setTimeout(() => {
						if (!chatEnded) { // ì±„íŒ…ì´ ì¢…ë£Œë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œë§Œ ë²„íŠ¼ í™œì„±í™”
							sendButton.disabled = false;
						}
					}, 500);
				}
			}

			// ì±„íŒ… ì¢…ë£Œ
			function endChat() {
				if (!connected || !roomId || chatEnded) {
					return;
				}

				if (confirm('ì±„íŒ…ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
					const now = new Date();
					const timeString = now.toLocaleString('ko-KR', {
						year: 'numeric',
						month: 'long',
						day: 'numeric',
						hour: '2-digit',
						minute: '2-digit'
					});

					const endMessage = {
						type: 'END',
						content: `---- ${timeString} ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í–‰ë³µí•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ----`,
						sender: username,
						roomId: roomId,
						timestamp: new Date().getTime()
					};

					try {
						// ë¡œì»¬ì— ì¦‰ì‹œ í‘œì‹œ
						displayMessage(endMessage, false);
						
						// ì„œë²„ì— ì „ì†¡
						stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(endMessage));
						
						// ì±„íŒ… ì¢…ë£Œ ìƒíƒœë¡œ ë³€ê²½
						chatEnded = true;
						disableChatInput('ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.');
						
					} catch (error) {
						console.error('ì±„íŒ… ì¢…ë£Œ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
					}
				}
			}

			// ë©”ì‹œì§€ í‘œì‹œ
			function displayMessage(message, checkDuplicate = false) {
				if (message.type === 'JOIN') return false;
				
				const messageId = message.timestamp || message.createdAt || (message.sender + message.content + Date.now());
				
				if (checkDuplicate && messageIds.has(messageId)) {
					console.log('ì¤‘ë³µ ë©”ì‹œì§€ ë¬´ì‹œ:', messageId);
					return false;
				}
				
				if (checkDuplicate) {
					messageIds.add(messageId);
				}
				
				const messageDiv = document.createElement('div');
				
				if (message.type === 'END' || message.type === 'RESTART') {
					messageDiv.className = 'message system';
					messageDiv.innerHTML = `
						<div class="message-bubble">${message.content}</div>
					`;
				} else {
					messageDiv.className = 'message ' + (message.sender === username ? 'mine' : 'other');
					
					const bubble = document.createElement('div');
					bubble.className = 'message-bubble';
					bubble.textContent = message.content;

					const time = document.createElement('div');
					time.className = 'message-time';
					
					const messageTime = message.createdAt ? new Date(message.createdAt) : new Date();
					time.textContent = messageTime.toLocaleTimeString('ko-KR', {
						hour: '2-digit',
						minute: '2-digit'
					});

					messageDiv.appendChild(bubble);
					messageDiv.appendChild(time);
				}
				
				messagesDiv.appendChild(messageDiv);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
				
				return true;
			}

			// ì±„íŒ… ì…ë ¥ ë¹„í™œì„±í™” (ì¢…ë£Œ ìƒíƒœìš© - ì…ë ¥ì€ ê°€ëŠ¥í•˜ê²Œ)
			function disableChatInput(message) {
				// ì „ì†¡ ë²„íŠ¼ê³¼ ì¢…ë£Œ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”, ì…ë ¥ì°½ì€ í™œì„± ìƒíƒœ ìœ ì§€
				sendButton.disabled = true;
				endChatButton.disabled = true;
				
				statusInfo.textContent = message;
				statusInfo.className = 'connection-status disconnected';
			}

			// ì±„íŒ… ì…ë ¥ í™œì„±í™”
			function enableChatInput() {
				messageInput.disabled = false;
				sendButton.disabled = false;
				endChatButton.disabled = false;
				
				if (connected) {
					statusInfo.textContent = 'ì—°ê²°ë¨';
					statusInfo.className = 'connection-status connected';
				} else {
					statusInfo.textContent = 'ì—°ê²° ì¤‘...';
					statusInfo.className = 'connection-status';
				}
			}

			// ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
			function updateConnectionStatus(text, className) {
				connectionStatus.textContent = text;
				
				if (!chatEnded) {
					statusInfo.textContent = text;
					statusInfo.className = 'connection-status ' + className;
				}
			}

			// í…ìŠ¤íŠ¸ì˜ì—­ ìë™ í¬ê¸° ì¡°ì ˆ
			function autoResizeTextarea() {
				messageInput.style.height = 'auto';
				messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
			}

			// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
			function setupEventListeners() {
				sendButton.addEventListener('click', sendMessage);
				endChatButton.addEventListener('click', endChat);

				messageInput.addEventListener('input', autoResizeTextarea);
				
				messageInput.addEventListener('keypress', function(e) {
					if (e.key === 'Enter' && !e.shiftKey) {
						e.preventDefault();
						// ì±„íŒ… ì¢…ë£Œ ìƒíƒœì—ì„œë„ ì—”í„°ë¡œ ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥
						if (messageInput.value.trim()) {
							sendMessage();
						}
					}
				});

				// ì±„íŒ…ì´ ì¢…ë£Œëœ ìƒíƒœì—ì„œ íƒ€ì´í•‘ ì‹œì‘í•˜ë©´ ì•ˆë‚´
				messageInput.addEventListener('input', function() {
					if (chatEnded && messageInput.value.trim()) {
						statusInfo.textContent = 'Enterë¥¼ ëˆ„ë¥´ë©´ ìƒˆë¡œìš´ ë¬¸ì˜ê°€ ì‹œì‘ë©ë‹ˆë‹¤.';
						statusInfo.className = 'connection-status';
					} else if (chatEnded) {
						statusInfo.textContent = 'ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.';
						statusInfo.className = 'connection-status disconnected';
					}
				});
			}

			// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
			window.addEventListener('beforeunload', function() {
				if (stompClient) {
					stompClient.disconnect();
				}
			});
		</script>
	</div>
</body>
</html>